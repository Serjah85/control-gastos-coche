<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta name="description" content="Controla gastos por coche y por a√±o. Calcula coste real y ‚Ç¨/km. Importa/exporta Excel. OCR local para tickets.">
  <meta name="theme-color" content="#1e3c72">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Gastos Coche">

  <link rel="manifest" href="./manifest.json">
  <!-- Si usas icon.svg del manifest, genial. Si no, deja tu apple-touch-icon inline. -->
  <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Crect fill='%231e3c72' width='512' height='512'/%3E%3Ctext x='50%25' y='50%25' text-anchor='middle' dominant-baseline='central' font-size='300' fill='white'%3Eüöó%3C/text%3E%3C/svg%3E">

  <title>Control de Gastos del Coche</title>

  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
      min-height: 100vh;
      padding: 20px;
      color: #2c3e50;
    }
    .app-container { max-width: 1400px; margin: 0 auto; }
    .header {
      background: white;
      padding: 22px;
      border-radius: 12px;
      margin-bottom: 16px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    .header h1 {
      color: #1e3c72;
      font-size: 26px;
      margin-bottom: 6px;
      display:flex; align-items:center; gap:10px;
    }
    .subline {
      color:#666; font-size: 13px;
      display:flex; flex-wrap: wrap; gap: 8px;
      margin-bottom: 12px;
    }
    .filters {
      display:grid;
      grid-template-columns: 1fr 1fr auto;
      gap: 12px;
      align-items:end;
      margin-top: 10px;
    }
    .form-group { margin-bottom: 14px; }
    label {
      display:block;
      margin-bottom: 6px;
      color:#555;
      font-size: 13px;
      font-weight: 600;
    }
    input, select, textarea {
      width: 100%;
      padding: 10px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 14px;
      transition: border-color .2s;
      background: #fff;
    }
    input:focus, select:focus, textarea:focus {
      outline:none;
      border-color:#3498db;
    }

    .btn {
      background: #3498db;
      color: white;
      border: none;
      padding: 10px 14px;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 700;
      cursor: pointer;
      transition: background .2s, transform .05s;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      user-select:none;
      white-space:nowrap;
    }
    .btn:hover { background:#2980b9; }
    .btn:active { transform: translateY(1px); }
    .btn.secondary { background:#95a5a6; }
    .btn.secondary:hover { background:#7f8c8d; }
    .btn.danger { background:#e74c3c; }
    .btn.danger:hover { background:#c0392b; }
    .btn.orange {
      background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
    }

    .card {
      background:white;
      padding: 22px;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      margin-bottom: 16px;
    }

    .dashboard {
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 12px;
      margin-bottom: 16px;
    }
    .metric-card {
      background: white;
      padding: 18px;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      border-left: 4px solid;
    }
    .metric-card.total { border-left-color:#e74c3c; }
    .metric-card.cashback { border-left-color:#f39c12; }
    .metric-card.real { border-left-color:#27ae60; }
    .metric-card.km { border-left-color:#3498db; }
    .metric-card.cost { border-left-color:#9b59b6; }

    .metric-label {
      font-size: 12px;
      color:#666;
      text-transform: uppercase;
      letter-spacing: .4px;
      margin-bottom: 8px;
      font-weight:700;
    }
    .metric-value {
      font-size: 26px;
      font-weight: 900;
      color:#2c3e50;
    }
    .metric-value.positive { color:#27ae60; }

    .tabs {
      display:flex;
      gap: 10px;
      margin-bottom: 16px;
      border-bottom: 2px solid #e0e0e0;
      flex-wrap: wrap;
    }
    .tab {
      padding: 10px 14px;
      background:none;
      border:none;
      border-bottom: 3px solid transparent;
      cursor:pointer;
      color:#666;
      font-weight: 800;
      font-size: 13px;
    }
    .tab.active { color:#3498db; border-bottom-color:#3498db; }
    .tab:hover { color:#3498db; }

    .hidden { display:none; }

    .form-row {
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
    }
    .info-text { font-size: 12px; color:#666; margin-top: 4px; font-style: italic; }

    .button-group {
      display:flex; flex-wrap:wrap;
      gap: 10px;
      margin-top: 14px;
    }

    .expense-list { max-height: 600px; overflow-y:auto; }
    .expense-item {
      background:#f8f9fa;
      padding: 14px;
      border-radius: 10px;
      margin-bottom: 10px;
      border-left: 4px solid;
    }
    .expense-item.fuel { border-left-color:#3498db; }
    .expense-item.maintenance { border-left-color:#e67e22; }
    .expense-item.itv { border-left-color:#27ae60; }
    .expense-item.insurance { border-left-color:#9b59b6; }
    .expense-item.tax { border-left-color:#34495e; }
    .expense-item.other { border-left-color:#95a5a6; }

    .expense-header {
      display:flex; justify-content:space-between; align-items:center;
      gap: 10px; flex-wrap:wrap;
      margin-bottom: 6px;
    }
    .expense-date { font-size: 12px; color:#666; }
    .expense-amount { font-size: 18px; font-weight: 900; }

    .badge {
      display:inline-block;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 800;
      color:white;
      margin-right: 6px;
    }
    .b-fuel { background:#3498db; }
    .b-maintenance { background:#e67e22; }
    .b-itv { background:#27ae60; }
    .b-insurance { background:#9b59b6; }
    .b-tax { background:#34495e; }
    .b-other { background:#95a5a6; }

    .pm-badge {
      display:inline-block;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 900;
      margin-left: 6px;
    }
    .pm-ing { background:#ff6200; color:white; }
    .pm-carrefour { background:#0057a0; color:white; }
    .pm-other { background:#e0e0e0; color:#555; }

    .expense-actions { margin-top: 10px; display:flex; gap: 8px; flex-wrap:wrap; }
    .expense-actions .btn { padding: 7px 10px; font-size: 12px; }

    .empty-state { text-align:center; padding: 34px; color:#999; }
    .empty-icon { font-size: 44px; margin-bottom: 12px; }

    .stats-grid {
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 12px;
      margin-top: 14px;
    }
    .stat-box {
      background:#f8f9fa;
      padding: 16px;
      border-radius: 10px;
      border-left: 4px solid #3498db;
    }
    .stat-box .label { font-size: 12px; color:#666; margin-bottom: 8px; text-transform:uppercase; font-weight: 900; }
    .stat-box .value { font-size: 22px; font-weight: 900; color:#2c3e50; }

    /* === Install banner === */
    .install-banner {
      background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
      color:white;
      padding: 14px 16px;
      border-radius: 10px;
      margin-bottom: 16px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap: 12px;
      box-shadow: 0 4px 6px rgba(0,0,0,.12);
    }
    .install-banner.hidden { display:none; }
    .install-banner-btn {
      background:white;
      color:#3498db;
      padding: 8px 12px;
      border-radius: 8px;
      border:none;
      font-weight: 900;
      cursor:pointer;
      font-size: 13px;
    }
    .install-banner-close {
      background:transparent;
      border:none;
      color:white;
      font-size: 20px;
      cursor:pointer;
      padding: 0 4px;
      opacity:.9;
    }

    /* === OCR Modal (IMPORTANT: hidden by default) === */
    #ocrModal {
      position: fixed;
      inset: 0;
      display: none;              /* <- oculto por defecto */
      align-items:center;
      justify-content:center;
      background: rgba(0,0,0,0.45);
      z-index: 9999;
      padding: 20px;
    }
    #ocrModal.open { display:flex; }
    body.modal-open { overflow:hidden; }

    .ocr-box {
      width: min(720px, 96vw);
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      padding: 18px;
    }
    .ocr-head {
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      margin-bottom: 10px;
    }
    .ocr-title {
      display:flex;
      align-items:center;
      gap: 10px;
      font-weight: 1000;
      color:#2c3e50;
      font-size: 16px;
    }
    .ocr-body { color:#555; font-size: 13px; line-height: 1.5; }
    .ocr-progress {
      width: 100%;
      height: 10px;
      background: #eef2f7;
      border-radius: 999px;
      overflow:hidden;
      margin-top: 10px;
    }
    .ocr-bar {
      height: 100%;
      width: 0%;
      background: #3498db;
      transition: width .2s;
    }
    .ocr-row {
      display:flex; gap: 10px; flex-wrap:wrap;
      margin-top: 12px;
      align-items:center;
      justify-content:flex-start;
    }
    .ocr-status { font-weight: 800; color:#666; }
    .ocr-small { font-size: 12px; color:#666; font-style: italic; }

    /* preview box */
    .preview-box {
      background:#f0f7ff;
      border: 2px dashed #3498db;
      padding: 16px;
      border-radius: 10px;
      margin-top: 12px;
    }
    .preview-box h3 { font-size: 15px; margin-bottom: 10px; }
    .preview-row { display:flex; justify-content:space-between; padding: 7px 0; border-bottom: 1px solid #ddd; }
    .preview-row:last-child { border-bottom:none; font-weight: 1000; color:#27ae60; border-top: 2px solid #27ae60; margin-top: 8px; padding-top: 10px; }

    /* file input hidden */
    input[type="file"] { display:none; }
    .file-upload-label { display:inline-block; }

    .footer {
      background:white;
      padding: 18px;
      border-radius: 12px;
      margin-top: 18px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      text-align:center;
    }
    .footer-text { color:#666; font-size: 13px; margin-bottom: 12px; line-height:1.6; }
    .coffee-btn {
      display:inline-flex;
      align-items:center;
      gap:8px;
      background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
      color:white;
      padding: 10px 18px;
      border-radius: 999px;
      text-decoration:none;
      font-weight: 900;
      font-size: 13px;
      box-shadow: 0 4px 8px rgba(243,156,18,.25);
    }
    .coffee-btn:hover { filter: brightness(1.02); }

    @media (max-width: 820px){
      .filters { grid-template-columns: 1fr; }
      .form-row { grid-template-columns: 1fr; }
      body { padding: 12px; }
    }
  </style>
</head>

<body>
  <div class="app-container">

    <!-- Banner instalaci√≥n PWA -->
    <div id="installBanner" class="install-banner hidden">
      <div style="flex:1; font-size:14px;">
        üì± <strong>Instala la app</strong> en tu m√≥vil para acceso r√°pido (PWA)
      </div>
      <button class="install-banner-btn" type="button" onclick="installPWA()">Instalar</button>
      <button class="install-banner-close" type="button" onclick="closeInstallBanner()">√ó</button>
    </div>

    <div class="header">
      <h1>üöó Control de Gastos del Coche</h1>

      <div class="subline">
        <span><strong>Vista actual:</strong> <span id="viewLabel">‚Äî</span></span>
        <span>¬∑</span>
        <span><strong>Kilometraje actual:</strong> <span id="currentKm">0</span> km</span>
      </div>

      <div class="filters">
        <div class="form-group" style="margin-bottom:0;">
          <label>Coche</label>
          <select id="carSelect" onchange="onChangeCar()"></select>
        </div>

        <div class="form-group" style="margin-bottom:0;">
          <label>A√±o</label>
          <select id="yearSelect" onchange="onChangeYear()"></select>
        </div>

        <div class="form-group" style="margin-bottom:0;">
          <button class="btn secondary" type="button" onclick="addCar()">‚ûï A√±adir coche</button>
        </div>
      </div>

      <div class="info-text">
        Consejo: en un coche nuevo, crea el coche y pon un ‚Äúkilometraje base‚Äù para que el coste/km salga fino.
      </div>
    </div>

    <!-- Dashboard -->
    <div class="dashboard">
      <div class="metric-card total">
        <div class="metric-label">Total pagado (ticket)</div>
        <div class="metric-value" id="totalPaid">0.00 ‚Ç¨</div>
      </div>
      <div class="metric-card cashback">
        <div class="metric-label">Cashback/puntos (a devolver)</div>
        <div class="metric-value positive" id="totalCashback">-0.00 ‚Ç¨</div>
      </div>
      <div class="metric-card real">
        <div class="metric-label">Coste real final</div>
        <div class="metric-value" id="realCost">0.00 ‚Ç¨</div>
      </div>
      <div class="metric-card km">
        <div class="metric-label">Kil√≥metros (scope)</div>
        <div class="metric-value" id="totalKm">0 km</div>
      </div>
      <div class="metric-card cost">
        <div class="metric-label">Coste por km</div>
        <div class="metric-value" id="costPerKm">0.000 ‚Ç¨/km</div>
      </div>
    </div>

    <div class="card">
      <div class="tabs">
        <button class="tab active" type="button" onclick="showTab('add', this)">‚ûï A√±adir gasto</button>
        <button class="tab" type="button" onclick="showTab('list', this)">üìã Lista de gastos</button>
        <button class="tab" type="button" onclick="showTab('stats', this)">üìä Estad√≠sticas</button>
      </div>

      <!-- TAB ADD -->
      <div id="tabAdd" class="tab-content">
        <form id="expenseForm" onsubmit="handleSubmit(event)">

          <div class="form-row">
            <div class="form-group">
              <label>Fecha</label>
              <input type="date" id="date" required>
            </div>

            <div class="form-group">
              <label>Categor√≠a</label>
              <select id="category" onchange="onCategoryChange()">
                <option value="fuel">‚õΩ Combustible</option>
                <option value="maintenance">üîß Mantenimiento</option>
                <option value="itv">‚úÖ ITV</option>
                <option value="insurance">üõ°Ô∏è Seguro</option>
                <option value="tax">üìã Impuestos</option>
                <option value="other">üìå Otros</option>
              </select>
            </div>
          </div>

          <div class="form-group">
            <label>Descripci√≥n</label>
            <input type="text" id="description" placeholder="Ej: Repostaje Carrefour, Cambio aceite, etc.">
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>Importe pagado (‚Ç¨) ‚Äî total del ticket</label>
              <input type="number" step="0.01" id="amount" required oninput="updatePreview()">
            </div>
            <div class="form-group">
              <label>Kilometraje</label>
              <input type="number" id="odometer" required placeholder="Ej: 85432" oninput="updatePreview()">
            </div>
          </div>

          <!-- Fuel fields -->
          <div id="fuelFields">
            <div class="form-row">
              <div class="form-group">
                <label>Litros</label>
                <input type="number" step="0.01" id="liters" placeholder="Ej: 45.50" oninput="updatePreview()">
              </div>
              <div class="form-group">
                <label>Precio/Litro visible (‚Ç¨)</label>
                <input type="number" step="0.001" id="pricePerLiter" placeholder="Ej: 1.459" oninput="updatePreview()">
                <div class="info-text">Precio que aparece en surtidor/ticket</div>
              </div>
            </div>
          </div>

          <div class="form-group">
            <label>M√©todo de pago</label>
            <select id="paymentMethod" onchange="onPaymentMethodChange()">
              <option value="other">Otro</option>
              <option value="carrefour">Carrefour (8% cheque ahorro en combustible)</option>
              <option value="ing_galp">ING (Galp 3% cashback)</option>
            </select>
            <div class="info-text">Reglas autom√°ticas: Carrefour 8% (solo combustible), ING 3% (solo Galp).</div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>Descuento inmediato (‚Ç¨)</label>
              <input type="number" step="0.01" id="immediateDiscount" value="0" oninput="updatePreview()">
              <div class="info-text">Descuento aplicado en el momento</div>
            </div>
            <div class="form-group">
              <label>Cashback diferido manual (‚Ç¨)</label>
              <input type="number" step="0.01" id="deferredCashbackManual" value="0" oninput="updatePreview()">
              <div class="info-text">Si tienes puntos/cheques distintos a las reglas autom√°ticas.</div>
            </div>
          </div>

          <div class="form-group">
            <label>Notas</label>
            <textarea id="notes" rows="3" placeholder="Cualquier anotaci√≥n adicional..."></textarea>
          </div>

          <!-- Preview -->
          <div id="previewBox" class="preview-box hidden">
            <h3>Vista previa del gasto</h3>
            <div id="previewContent"></div>
          </div>

          <div class="button-group">
            <button class="btn" type="submit" id="submitBtn">‚ûï A√±adir gasto</button>
            <button class="btn secondary" type="button" id="cancelBtn" onclick="cancelEdit()" style="display:none;">‚ùå Cancelar</button>

            <button class="btn secondary" type="button" onclick="exportToExcel()">üìä Exportar Excel</button>

            <label class="file-upload-label">
              <button class="btn secondary" type="button">üì• Importar Excel</button>
              <input type="file" id="importFile" accept=".xlsx,.xls" onchange="importFromExcel(event)">
            </label>

            <label class="file-upload-label">
              <button class="btn orange" type="button" onclick="startOcrFlow()">üì∑ Leer ticket OCR</button>
              <input type="file" id="ocrFile" accept="image/*" onchange="onOcrFileSelected(event)">
            </label>

            <button class="btn danger" type="button" onclick="resetAllConfirm()">üß® Reset datos</button>
          </div>
        </form>
      </div>

      <!-- TAB LIST -->
      <div id="tabList" class="tab-content hidden">
        <div id="expensesList"></div>
      </div>

      <!-- TAB STATS -->
      <div id="tabStats" class="tab-content hidden">
        <div id="statsContent"></div>
      </div>
    </div>

    <div class="footer">
      <div class="footer-text">
        ¬øTe est√° ayudando a ahorrar en gasolina? üöóüí∞<br>
        Si te resulta √∫til, puedes invitarme a un caf√©
      </div>
      <a href="https://paypal.me/perfectamaquinaria" target="_blank" class="coffee-btn" rel="noopener">
        ‚òï Inv√≠tame a un caf√©
      </a>
    </div>
  </div>

  <!-- OCR MODAL (IMPORTANTE: no se abre nunca salvo bot√≥n) -->
  <div id="ocrModal" aria-hidden="true">
    <div class="ocr-box" role="dialog" aria-modal="true">
      <div class="ocr-head">
        <div class="ocr-title">üì∑ Lectura de ticket (OCR)</div>
        <button class="btn secondary" type="button" onclick="closeOcrModal(event)">Cerrar</button>
      </div>
      <div class="ocr-body">
        <div class="ocr-small">Se procesa en tu dispositivo. No se sube a Internet.</div>
        <div style="margin-top:8px;">
          <span class="ocr-status">Estado:</span> <span id="ocrStatus">En espera‚Ä¶</span>
        </div>
        <div class="ocr-progress" aria-label="Progreso OCR">
          <div class="ocr-bar" id="ocrBar"></div>
        </div>
        <div class="ocr-row">
          <button class="btn" type="button" onclick="triggerOcrFile()">üì§ Seleccionar foto del ticket</button>
          <button class="btn secondary" type="button" onclick="fillOcrDemo()">üß™ Demo (Carrefour)</button>
        </div>
      </div>
    </div>
  </div>

  <!-- SheetJS -->
  <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
  <!-- Tesseract (OCR) - se carga cuando se use -->
  <!-- <script src="https://unpkg.com/tesseract.js@5/dist/tesseract.min.js"></script> -->

  <script>
    /******************************************************************
     * CONFIG
     ******************************************************************/
    const STORAGE_KEYS = {
      cars: "cg_cars_v1",
      expenses: "cg_expenses_v1",
      ui: "cg_ui_v1"
    };

    const CATEGORIES = {
      fuel: { label:"Combustible", icon:"‚õΩ", badge:"b-fuel" },
      maintenance: { label:"Mantenimiento", icon:"üîß", badge:"b-maintenance" },
      itv: { label:"ITV", icon:"‚úÖ", badge:"b-itv" },
      insurance: { label:"Seguro", icon:"üõ°Ô∏è", badge:"b-insurance" },
      tax: { label:"Impuestos", icon:"üìã", badge:"b-tax" },
      other: { label:"Otros", icon:"üìå", badge:"b-other" }
    };

    const PAYMENT_METHODS = {
      other: { label:"Otro", pmClass:"pm-other" },
      carrefour: { label:"Carrefour 8%", pmClass:"pm-carrefour" },
      ing_galp: { label:"ING Galp 3%", pmClass:"pm-ing" }
    };

    // Reglas autom√°ticas (las que t√∫ has definido)
    function autoCashback(expense) {
      const amount = Number(expense.amount || 0);
      const immediate = Number(expense.immediateDiscount || 0);
      const manualDeferred = Number(expense.deferredCashbackManual || 0);

      let autoDeferred = 0;
      let autoBankCashback = 0;

      // Carrefour 8% SOLO en combustible
      if (expense.paymentMethod === "carrefour" && expense.category === "fuel") {
        autoDeferred = amount * 0.08;
      }

      // ING 3% SOLO si m√©todo ING Galp
      if (expense.paymentMethod === "ing_galp") {
        autoBankCashback = amount * 0.03;
      }

      const totalCashback = immediate + manualDeferred + autoDeferred + autoBankCashback;

      return {
        immediate,
        manualDeferred,
        autoDeferred,
        autoBankCashback,
        totalCashback
      };
    }

    /******************************************************************
     * STATE
     ******************************************************************/
    let cars = [];
    let expenses = [];
    let selectedCarId = null;
    let selectedYear = "all"; // "all" o "2026", etc.
    let editingExpenseId = null;

    /******************************************************************
     * LOAD/SAVE
     ******************************************************************/
    function loadAll() {
      cars = safeJsonParse(localStorage.getItem(STORAGE_KEYS.cars), []);
      expenses = safeJsonParse(localStorage.getItem(STORAGE_KEYS.expenses), []);

      // Asegura 1 coche si no hay ninguno
      if (!cars.length) {
        const defaultCar = {
          id: uid(),
          name: "Mi coche",
          baseOdometer: 0,
          createdAt: new Date().toISOString()
        };
        cars.push(defaultCar);
        saveCars();
      }

      const ui = safeJsonParse(localStorage.getItem(STORAGE_KEYS.ui), null);
      selectedCarId = ui?.selectedCarId || cars[0].id;
      selectedYear = ui?.selectedYear || "all";

      // Fecha por defecto
      document.getElementById("date").valueAsDate = new Date();

      buildCarSelect();
      buildYearSelect();
      refreshAll();
    }

    function saveCars() {
      localStorage.setItem(STORAGE_KEYS.cars, JSON.stringify(cars));
    }
    function saveExpenses() {
      localStorage.setItem(STORAGE_KEYS.expenses, JSON.stringify(expenses));
    }
    function saveUI() {
      localStorage.setItem(STORAGE_KEYS.ui, JSON.stringify({
        selectedCarId,
        selectedYear
      }));
    }

    function safeJsonParse(str, fallback) {
      try { return str ? JSON.parse(str) : fallback; } catch { return fallback; }
    }

    function uid() {
      return Date.now().toString(36) + Math.random().toString(36).slice(2, 9);
    }

    /******************************************************************
     * FILTERS
     ******************************************************************/
    function getCurrentCar() {
      return cars.find(c => c.id === selectedCarId) || cars[0];
    }

    function getExpensesInScope() {
      const carId = selectedCarId;
      let list = expenses.filter(e => e.carId === carId);

      if (selectedYear !== "all") {
        list = list.filter(e => String(e.year) === String(selectedYear));
      }
      // Orden: m√°s nuevo arriba
      list.sort((a,b) => new Date(b.date) - new Date(a.date));
      return list;
    }

    function getAllYearsForCar(carId) {
      const years = new Set(
        expenses.filter(e => e.carId === carId).map(e => e.year)
      );
      return Array.from(years).sort((a,b) => b - a);
    }

    /******************************************************************
     * UI BUILD
     ******************************************************************/
    function buildCarSelect() {
      const sel = document.getElementById("carSelect");
      sel.innerHTML = cars.map(c => `<option value="${c.id}">${escapeHtml(c.name)}</option>`).join("");
      sel.value = selectedCarId;
    }

    function buildYearSelect() {
      const sel = document.getElementById("yearSelect");
      const years = getAllYearsForCar(selectedCarId);
      const options = [
        `<option value="all">Todos los a√±os</option>`,
        ...years.map(y => `<option value="${y}">${y}</option>`)
      ];
      sel.innerHTML = options.join("");
      sel.value = selectedYear;
    }

    function onChangeCar() {
      selectedCarId = document.getElementById("carSelect").value;
      // Cuando cambias coche, resetea a√±o a "all" si el a√±o actual no existe
      const years = getAllYearsForCar(selectedCarId);
      if (selectedYear !== "all" && !years.includes(Number(selectedYear))) {
        selectedYear = "all";
      }
      saveUI();
      buildYearSelect();
      refreshAll();
      resetForm();
    }

    function onChangeYear() {
      selectedYear = document.getElementById("yearSelect").value;
      saveUI();
      refreshAll();
    }

    function refreshAll() {
      updateHeaderLine();
      updateDashboard();
      renderExpensesList();
      renderStats();
      onCategoryChange();
      updatePreview();
    }

    function updateHeaderLine() {
      const car = getCurrentCar();
      const yearLabel = selectedYear === "all" ? "Todos los a√±os" : selectedYear;
      document.getElementById("viewLabel").textContent = `${car.name} ¬∑ ${yearLabel}`;

      // Kilometraje actual: el m√°ximo od√≥metro registrado para el coche (si hay)
      const carExpenses = expenses.filter(e => e.carId === car.id);
      const maxOdo = carExpenses.length ? Math.max(...carExpenses.map(e => Number(e.odometer || 0))) : car.baseOdometer || 0;
      document.getElementById("currentKm").textContent = Math.round(maxOdo).toString();
    }

    /******************************************************************
     * DASHBOARD CALCS
     ******************************************************************/
    function updateDashboard() {
      const scope = getExpensesInScope();
      const car = getCurrentCar();

      const totalPaid = scope.reduce((s,e) => s + Number(e.amount||0), 0);
      const totalCashback = scope.reduce((s,e) => s + autoCashback(e).totalCashback, 0);
      const realCost = totalPaid - totalCashback;

      // km: (max od√≥metro en scope) - (min od√≥metro base scope)
      // Usamos baseOdometer del coche como base si no hay datos suficientes.
      const odos = scope.map(e => Number(e.odometer||0)).filter(n => n>0);
      const maxOdo = odos.length ? Math.max(...odos) : (car.baseOdometer || 0);
      const minBase = car.baseOdometer || (odos.length ? Math.min(...odos) : 0);

      const totalKm = Math.max(0, maxOdo - minBase);
      const costPerKm = totalKm > 0 ? realCost / totalKm : 0;

      document.getElementById("totalPaid").textContent = totalPaid.toFixed(2) + " ‚Ç¨";
      document.getElementById("totalCashback").textContent = "-" + totalCashback.toFixed(2) + " ‚Ç¨";
      document.getElementById("realCost").textContent = realCost.toFixed(2) + " ‚Ç¨";
      document.getElementById("totalKm").textContent = Math.round(totalKm) + " km";
      document.getElementById("costPerKm").textContent = costPerKm.toFixed(3) + " ‚Ç¨/km";
    }

    /******************************************************************
     * TABS
     ******************************************************************/
    function showTab(name, btn) {
      document.querySelectorAll(".tab-content").forEach(el => el.classList.add("hidden"));
      document.querySelectorAll(".tab").forEach(el => el.classList.remove("active"));

      const map = { add:"tabAdd", list:"tabList", stats:"tabStats" };
      document.getElementById(map[name]).classList.remove("hidden");
      if (btn) btn.classList.add("active");

      if (name === "stats") renderStats();
      if (name === "list") renderExpensesList();
    }

    /******************************************************************
     * FORM
     ******************************************************************/
    function onCategoryChange() {
      const cat = document.getElementById("category").value;
      document.getElementById("fuelFields").style.display = (cat === "fuel") ? "block" : "none";
      updatePreview();
    }

    function onPaymentMethodChange() {
      updatePreview();
    }

    function handleSubmit(ev) {
      ev.preventDefault();

      const car = getCurrentCar();
      const date = document.getElementById("date").value;
      const year = date ? Number(date.slice(0,4)) : new Date().getFullYear();

      const expense = {
        id: editingExpenseId || uid(),
        carId: car.id,
        date,
        year,
        category: document.getElementById("category").value,
        description: document.getElementById("description").value.trim(),
        amount: Number(document.getElementById("amount").value),
        odometer: Number(document.getElementById("odometer").value),
        liters: Number(document.getElementById("liters").value || 0),
        pricePerLiter: Number(document.getElementById("pricePerLiter").value || 0),
        paymentMethod: document.getElementById("paymentMethod").value,
        immediateDiscount: Number(document.getElementById("immediateDiscount").value || 0),
        deferredCashbackManual: Number(document.getElementById("deferredCashbackManual").value || 0),
        notes: document.getElementById("notes").value.trim(),
        updatedAt: new Date().toISOString()
      };

      if (!expense.date) return alert("Falta la fecha.");
      if (!expense.amount || expense.amount <= 0) return alert("Importe pagado inv√°lido.");
      if (!expense.odometer || expense.odometer <= 0) return alert("Kilometraje inv√°lido.");

      if (editingExpenseId) {
        const idx = expenses.findIndex(e => e.id === editingExpenseId);
        if (idx >= 0) expenses[idx] = { ...expenses[idx], ...expense };
        editingExpenseId = null;
      } else {
        expense.createdAt = new Date().toISOString();
        expenses.push(expense);
      }

      // Orden por fecha desc
      expenses.sort((a,b) => new Date(b.date) - new Date(a.date));

      saveExpenses();
      buildYearSelect(); // por si aparece a√±o nuevo
      refreshAll();
      resetForm();
    }

    function resetForm() {
      document.getElementById("expenseForm").reset();
      document.getElementById("date").valueAsDate = new Date();
      document.getElementById("category").value = "fuel";
      document.getElementById("paymentMethod").value = "other";
      document.getElementById("immediateDiscount").value = "0";
      document.getElementById("deferredCashbackManual").value = "0";
      document.getElementById("previewBox").classList.add("hidden");
      document.getElementById("submitBtn").textContent = "‚ûï A√±adir gasto";
      document.getElementById("cancelBtn").style.display = "none";
      editingExpenseId = null;
      onCategoryChange();
    }

    function cancelEdit() {
      resetForm();
    }

    function editExpense(id) {
      const e = expenses.find(x => x.id === id);
      if (!e) return;

      editingExpenseId = id;

      document.getElementById("date").value = e.date;
      document.getElementById("category").value = e.category;
      document.getElementById("description").value = e.description || "";
      document.getElementById("amount").value = e.amount;
      document.getElementById("odometer").value = e.odometer;
      document.getElementById("liters").value = e.liters || "";
      document.getElementById("pricePerLiter").value = e.pricePerLiter || "";
      document.getElementById("paymentMethod").value = e.paymentMethod || "other";
      document.getElementById("immediateDiscount").value = e.immediateDiscount || 0;
      document.getElementById("deferredCashbackManual").value = e.deferredCashbackManual || 0;
      document.getElementById("notes").value = e.notes || "";

      document.getElementById("submitBtn").textContent = "‚úÖ Actualizar gasto";
      document.getElementById("cancelBtn").style.display = "inline-flex";
      onCategoryChange();
      updatePreview();

      showTab("add", document.querySelector('.tab')); // activa add
    }

    function deleteExpense(id) {
      if (!confirm("¬øSeguro que quieres eliminar este gasto?")) return;
      expenses = expenses.filter(e => e.id !== id);
      saveExpenses();
      buildYearSelect();
      refreshAll();
    }

    /******************************************************************
     * PREVIEW
     ******************************************************************/
    function updatePreview() {
      const amount = Number(document.getElementById("amount").value || 0);
      if (!amount) {
        document.getElementById("previewBox").classList.add("hidden");
        return;
      }

      const expense = {
        amount,
        category: document.getElementById("category").value,
        paymentMethod: document.getElementById("paymentMethod").value,
        immediateDiscount: Number(document.getElementById("immediateDiscount").value || 0),
        deferredCashbackManual: Number(document.getElementById("deferredCashbackManual").value || 0),
        liters: Number(document.getElementById("liters").value || 0)
      };

      const cb = autoCashback(expense);
      const realCost = amount - cb.totalCashback;

      let html = `
        <div class="preview-row"><span>Importe pagado:</span><span>${amount.toFixed(2)} ‚Ç¨</span></div>
      `;

      if (cb.immediate > 0) {
        html += `<div class="preview-row"><span>- Descuento inmediato:</span><span>-${cb.immediate.toFixed(2)} ‚Ç¨</span></div>`;
      }

      if (cb.autoBankCashback > 0) {
        html += `<div class="preview-row"><span>- Cashback banco (ING 3%):</span><span>-${cb.autoBankCashback.toFixed(2)} ‚Ç¨</span></div>`;
      }

      if (cb.autoDeferred > 0) {
        html += `<div class="preview-row"><span>- Cheque ahorro (Carrefour 8%):</span><span>-${cb.autoDeferred.toFixed(2)} ‚Ç¨</span></div>`;
      }

      if (cb.manualDeferred > 0) {
        html += `<div class="preview-row"><span>- Diferido manual:</span><span>-${cb.manualDeferred.toFixed(2)} ‚Ç¨</span></div>`;
      }

      html += `<div class="preview-row"><span><strong>Coste real:</strong></span><span><strong>${realCost.toFixed(2)} ‚Ç¨</strong></span></div>`;

      if (expense.category === "fuel" && expense.liters > 0) {
        const realPrice = realCost / expense.liters;
        html += `<div class="preview-row"><span>Precio real por litro:</span><span>${realPrice.toFixed(3)} ‚Ç¨/L</span></div>`;
      }

      document.getElementById("previewContent").innerHTML = html;
      document.getElementById("previewBox").classList.remove("hidden");
    }

    /******************************************************************
     * LIST
     ******************************************************************/
    function renderExpensesList() {
      const container = document.getElementById("expensesList");
      const scope = getExpensesInScope();

      if (!scope.length) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">üìù</div>
            <div>No hay gastos registrados en esta vista</div>
          </div>
        `;
        return;
      }

      container.innerHTML = scope.map(e => {
        const cat = CATEGORIES[e.category] || CATEGORIES.other;
        const pm = PAYMENT_METHODS[e.paymentMethod] || PAYMENT_METHODS.other;
        const cb = autoCashback(e);
        const realCost = Number(e.amount) - cb.totalCashback;

        let details = `
          üí≥ Pagado: ${Number(e.amount).toFixed(2)} ‚Ç¨ |
          üí∞ Cashback: -${cb.totalCashback.toFixed(2)} ‚Ç¨ |
          ‚úÖ Real: ${realCost.toFixed(2)} ‚Ç¨
        `;

        if (e.category === "fuel" && Number(e.liters) > 0) {
          const priceReal = realCost / Number(e.liters);
          details += `<br>‚õΩ ${Number(e.liters).toFixed(2)} L | Precio visible: ${Number(e.pricePerLiter||0).toFixed(3)} ‚Ç¨/L | Precio real: ${priceReal.toFixed(3)} ‚Ç¨/L`;
        }

        return `
          <div class="expense-item ${escapeHtml(e.category)}">
            <div class="expense-header">
              <div>
                <span class="badge ${cat.badge}">${cat.icon} ${cat.label}</span>
                <span class="pm-badge ${pm.pmClass}">${pm.label}</span>
              </div>
              <div class="expense-amount">${realCost.toFixed(2)} ‚Ç¨</div>
            </div>
            <div class="expense-date">üìÖ ${escapeHtml(e.date)} | üõ£Ô∏è ${Number(e.odometer||0)} km</div>
            ${e.description ? `<div style="margin-top:6px; font-weight:900;">${escapeHtml(e.description)}</div>` : ``}
            <div style="margin-top:6px; font-size:13px; color:#555;">${details}</div>
            ${e.notes ? `<div style="margin-top:8px; font-size:13px; color:#555; font-style:italic;">üìù ${escapeHtml(e.notes)}</div>` : ``}
            <div class="expense-actions">
              <button class="btn secondary" type="button" onclick="editExpense('${e.id}')">‚úèÔ∏è Editar</button>
              <button class="btn danger" type="button" onclick="deleteExpense('${e.id}')">üóëÔ∏è Eliminar</button>
            </div>
          </div>
        `;
      }).join("");
    }

    /******************************************************************
     * STATS
     ******************************************************************/
    function renderStats() {
      const container = document.getElementById("statsContent");
      const scope = getExpensesInScope();

      if (!scope.length) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">üìä</div>
            <div>No hay datos suficientes para estad√≠sticas</div>
          </div>
        `;
        return;
      }

      const totalPaid = scope.reduce((s,e) => s + Number(e.amount||0), 0);
      const totalCashback = scope.reduce((s,e) => s + autoCashback(e).totalCashback, 0);
      const realCost = totalPaid - totalCashback;
      const avg = realCost / scope.length;
      const percent = totalPaid > 0 ? (totalCashback/totalPaid)*100 : 0;

      const byCategory = Object.keys(CATEGORIES).map(k => {
        const items = scope.filter(e => e.category === k);
        if (!items.length) return null;
        const total = items.reduce((s,e) => {
          const cb = autoCashback(e);
          return s + (Number(e.amount||0) - cb.totalCashback);
        }, 0);
        return { key:k, meta:CATEGORIES[k], count:items.length, total };
      }).filter(Boolean);

      const fuel = scope.filter(e => e.category === "fuel" && Number(e.liters) > 0);
      const avgFuel = fuel.length ? fuel.reduce((s,e) => {
        const cb = autoCashback(e);
        const real = Number(e.amount||0) - cb.totalCashback;
        return s + (real / Number(e.liters));
      }, 0) / fuel.length : 0;

      container.innerHTML = `
        <h3 style="margin-bottom:10px;">Estad√≠sticas generales</h3>
        <div class="stats-grid">
          <div class="stat-box">
            <div class="label">Gastos registrados</div>
            <div class="value">${scope.length}</div>
          </div>
          <div class="stat-box">
            <div class="label">Gasto medio (real)</div>
            <div class="value">${avg.toFixed(2)} ‚Ç¨</div>
          </div>
          <div class="stat-box">
            <div class="label">% Cashback total</div>
            <div class="value">${percent.toFixed(1)}%</div>
          </div>
          ${fuel.length ? `
            <div class="stat-box">
              <div class="label">Repostajes</div>
              <div class="value">${fuel.length}</div>
            </div>
            <div class="stat-box">
              <div class="label">Precio medio real</div>
              <div class="value">${avgFuel.toFixed(3)} ‚Ç¨/L</div>
            </div>
          `:``}
        </div>

        <h3 style="margin:22px 0 10px;">Por categor√≠a (coste real)</h3>
        <div class="stats-grid">
          ${byCategory.map(x => `
            <div class="stat-box" style="border-left-color:${x.meta.key === 'fuel' ? '#3498db' : '#3498db'}">
              <div class="label">${x.meta.icon} ${x.meta.label}</div>
              <div class="value">${x.total.toFixed(2)} ‚Ç¨</div>
              <div class="info-text">${x.count} gasto${x.count!==1?'s':''}</div>
            </div>
          `).join("")}
        </div>
      `;
    }

    /******************************************************************
     * CARS
     ******************************************************************/
    function addCar() {
      const name = prompt("Nombre del coche (ej: Auris, Coche Vero, etc.):");
      if (!name) return;

      const base = prompt("Kilometraje base (n√∫mero, ej: 256703). Si no sabes, pon 0:", "0");
      const baseOdometer = Number(base || 0);
      if (Number.isNaN(baseOdometer) || baseOdometer < 0) return alert("Kilometraje base inv√°lido.");

      const car = { id: uid(), name: name.trim(), baseOdometer, createdAt: new Date().toISOString() };
      cars.push(car);
      saveCars();

      selectedCarId = car.id;
      selectedYear = "all";
      saveUI();

      buildCarSelect();
      buildYearSelect();
      refreshAll();
      resetForm();
    }

    /******************************************************************
     * EXCEL EXPORT/IMPORT
     ******************************************************************/
    function exportToExcel() {
      if (!window.XLSX) {
        alert("La librer√≠a Excel no est√° cargada. Recarga la p√°gina.");
        return;
      }

      const wb = XLSX.utils.book_new();
      const scope = getExpensesInScope();
      const car = getCurrentCar();

      const rows = scope.map(e => {
        const cb = autoCashback(e);
        const real = Number(e.amount||0) - cb.totalCashback;

        return {
          "Coche": car.name,
          "A√±o": e.year,
          "Fecha": e.date,
          "Categor√≠a": (CATEGORIES[e.category] || CATEGORIES.other).label,
          "Descripci√≥n": e.description || "",
          "Kilometraje": Number(e.odometer || 0),
          "Importe pagado (ticket)": Number(e.amount || 0).toFixed(2),
          "M√©todo pago": (PAYMENT_METHODS[e.paymentMethod] || PAYMENT_METHODS.other).label,
          "Dto inmediato": cb.immediate.toFixed(2),
          "Diferido manual": cb.manualDeferred.toFixed(2),
          "Cheque Carrefour auto": cb.autoDeferred.toFixed(2),
          "Cashback ING auto": cb.autoBankCashback.toFixed(2),
          "Cashback total": cb.totalCashback.toFixed(2),
          "Coste real": real.toFixed(2),
          "Litros": e.liters ? Number(e.liters).toFixed(2) : "",
          "Precio/L visible": e.pricePerLiter ? Number(e.pricePerLiter).toFixed(3) : "",
          "Precio/L real": (e.category==="fuel" && Number(e.liters)>0) ? (real/Number(e.liters)).toFixed(3) : "",
          "Notas": e.notes || ""
        };
      });

      const ws = XLSX.utils.json_to_sheet(rows);
      XLSX.utils.book_append_sheet(wb, ws, "Gastos");

      const fecha = new Date().toISOString().split("T")[0];
      const yearLabel = selectedYear === "all" ? "ALL" : selectedYear;
      XLSX.writeFile(wb, `Gastos_${sanitizeFile(car.name)}_${yearLabel}_${fecha}.xlsx`);
    }

    function importFromExcel(event) {
      const file = event.target.files[0];
      if (!file || !window.XLSX) return;

      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const wb = XLSX.read(e.target.result, { type: "binary" });
          const ws = wb.Sheets[wb.SheetNames[0]];
          const data = XLSX.utils.sheet_to_json(ws);

          const car = getCurrentCar();

          const imported = data.map(row => {
            const date = row["Fecha"] || row["date"] || row["FECHA"];
            const year = date ? Number(String(date).slice(0,4)) : new Date().getFullYear();

            // Intento mapear categor√≠a por label
            const catLabel = row["Categor√≠a"] || row["categoria"] || "";
            const catKey = Object.keys(CATEGORIES).find(k => CATEGORIES[k].label === catLabel) || "other";

            // M√©todo pago
            const pmLabel = row["M√©todo pago"] || row["M√©todo Pago"] || "";
            const pmKey = Object.keys(PAYMENT_METHODS).find(k => PAYMENT_METHODS[k].label === pmLabel) || "other";

            return {
              id: uid(),
              carId: car.id,
              date: String(date || ""),
              year,
              category: catKey,
              description: String(row["Descripci√≥n"] || ""),
              odometer: Number(row["Kilometraje"] || 0),
              amount: Number(row["Importe pagado (ticket)"] || row["Importe Pagado"] || 0),
              paymentMethod: pmKey,
              immediateDiscount: Number(row["Dto inmediato"] || row["Dto. Inmediato"] || 0),
              deferredCashbackManual: Number(row["Diferido manual"] || row["Cashback Diferido"] || 0),
              liters: Number(row["Litros"] || 0),
              pricePerLiter: Number(row["Precio/L visible"] || row["Precio/L Visible"] || 0),
              notes: String(row["Notas"] || ""),
              createdAt: new Date().toISOString()
            };
          }).filter(x => x.date && x.amount > 0);

          expenses = [...imported, ...expenses].sort((a,b) => new Date(b.date) - new Date(a.date));
          saveExpenses();
          buildYearSelect();
          refreshAll();

          alert(`${imported.length} gastos importados correctamente.`);
        } catch(err) {
          console.error(err);
          alert("Error importando el Excel. Aseg√∫rate de que sea un archivo v√°lido.");
        }
      };

      reader.readAsBinaryString(file);
      event.target.value = "";
    }

    function sanitizeFile(str) {
      return String(str || "coche").replace(/[^\w\-]+/g, "_").slice(0,40);
    }

    /******************************************************************
     * RESET
     ******************************************************************/
    function resetAllConfirm() {
      const ok = confirm("Esto borrar√° TODOS los coches y gastos guardados en este navegador. ¬øSeguro?");
      if (!ok) return;

      localStorage.removeItem(STORAGE_KEYS.cars);
      localStorage.removeItem(STORAGE_KEYS.expenses);
      localStorage.removeItem(STORAGE_KEYS.ui);

      cars = [];
      expenses = [];
      selectedCarId = null;
      selectedYear = "all";
      editingExpenseId = null;

      loadAll();
      alert("Datos reseteados.");
    }

    /******************************************************************
     * OCR FLOW (NO AUTO-OPEN)
     ******************************************************************/
    let tesseractLoaded = false;
    let ocrWorker = null;

    function startOcrFlow() {
      // ABRE MODAL SOLO AQU√ç
      openOcrModal();
      setOcrStatus("En espera‚Ä¶ Pulsa ‚ÄúSeleccionar foto del ticket‚Äù.", 0);
    }

    function openOcrModal() {
      const modal = document.getElementById("ocrModal");
      modal.classList.add("open");
      document.body.classList.add("modal-open");
      modal.setAttribute("aria-hidden", "false");
    }

    function closeOcrModal(e) {
      if (e) { e.preventDefault(); e.stopPropagation(); }
      const modal = document.getElementById("ocrModal");
      modal.classList.remove("open");
      document.body.classList.remove("modal-open");
      modal.setAttribute("aria-hidden", "true");
      setOcrStatus("En espera‚Ä¶", 0);
    }

    function setOcrStatus(text, pct) {
      document.getElementById("ocrStatus").textContent = text;
      const bar = document.getElementById("ocrBar");
      bar.style.width = `${Math.max(0, Math.min(100, pct || 0))}%`;
    }

    function triggerOcrFile() {
      document.getElementById("ocrFile").click();
    }

    async function onOcrFileSelected(event) {
      const file = event.target.files[0];
      if (!file) return;
      try {
        await runOCR(file);
      } finally {
        // reset input
        event.target.value = "";
      }
    }

    async function ensureTesseract() {
      if (tesseractLoaded) return;

      setOcrStatus("Cargando OCR‚Ä¶", 10);
      await loadScript("https://unpkg.com/tesseract.js@5/dist/tesseract.min.js");
      tesseractLoaded = true;
    }

    async function runOCR(file) {
      openOcrModal(); // por si ven√≠a abierto ya; asegura estado
      await ensureTesseract();

      setOcrStatus("Preparando‚Ä¶", 15);

      // OCR simple sin worker persistente (m√°s compatible en m√≥viles)
      // Si quieres ultra r√°pido, lo hacemos con worker persistente; pero as√≠ va estable.
      const { createWorker } = Tesseract;

      const worker = await createWorker("spa", 1, {
        logger: m => {
          if (m.status === "recognizing text") {
            const p = Math.round((m.progress || 0) * 100);
            setOcrStatus("Leyendo texto‚Ä¶", 15 + Math.round(p * 0.75));
          }
        }
      });

      try {
        setOcrStatus("Analizando ticket‚Ä¶", 35);
        const imgUrl = await fileToDataURL(file);

        const { data } = await worker.recognize(imgUrl);
        const text = (data.text || "").replace(/\r/g, "\n");

        setOcrStatus("Extrayendo datos‚Ä¶", 92);

        const parsed = parseReceiptText(text);

        // Relleno de campos con lo que encontremos
        if (parsed.date) document.getElementById("date").value = parsed.date;
        if (parsed.amount) document.getElementById("amount").value = parsed.amount.toFixed(2);

        // si detecta litros/precio
        if (parsed.liters) document.getElementById("liters").value = parsed.liters.toFixed(2);
        if (parsed.pricePerLiter) document.getElementById("pricePerLiter").value = parsed.pricePerLiter.toFixed(3);

        // sugerencias
        if (parsed.suggestCarrefour) {
          document.getElementById("paymentMethod").value = "carrefour";
          document.getElementById("category").value = "fuel";
          onCategoryChange();
        }

        updatePreview();
        setOcrStatus("Listo ‚úÖ (revisa y completa kilometraje)", 100);

        // No cierro autom√°ticamente: mejor que lo revises
        // Si lo quieres auto-cerrar al terminar, d√≠melo y lo ajusto.
      } catch (err) {
        console.error(err);
        setOcrStatus("Error leyendo el ticket. Prueba otra foto (m√°s cerca y con buena luz).", 0);
      } finally {
        await worker.terminate();
      }
    }

    function parseReceiptText(text) {
      // Normalizaci√≥n
      const t = text
        .replace(/[ ]{2,}/g, " ")
        .replace(/‚Ç¨/g, " EUR")
        .replace(/\,/g, "."); // decimal a punto

      // Fecha (Carrefour suele: 08.01.26 o 08/01/2026)
      let date = null;
      const mDate1 = t.match(/\b(\d{2})[.\/-](\d{2})[.\/-](\d{2,4})\b/);
      if (mDate1) {
        const dd = mDate1[1], mm = mDate1[2], yy = mDate1[3];
        const yyyy = yy.length === 2 ? ("20" + yy) : yy;
        date = `${yyyy}-${mm}-${dd}`; // input date espera YYYY-MM-DD
      }

      // Total / Importe (buscar "TOTAL EUROS:" o "IMPORTE")
      let amount = null;
      const candidates = [];

      // TOTAL EUROS: 74.03
      const mTot = t.match(/TOTAL\s*(EUROS|EUR)\s*[: ]\s*(\d+\.\d{2})/i);
      if (mTot) candidates.push(Number(mTot[2]));

      // IMPORTE 74.03 EUR
      const mImp = t.match(/\bIMPORTE\b\s*(\d+\.\d{2})/i);
      if (mImp) candidates.push(Number(mImp[1]));

      // √öltimo patr√≥n de EUR suelto (por si lo dem√°s falla)
      const mAny = t.match(/(\d+\.\d{2})\s*EUR\b/gi);
      if (mAny && mAny.length) {
        const last = mAny[mAny.length - 1].match(/(\d+\.\d{2})/);
        if (last) candidates.push(Number(last[1]));
      }

      // Elegimos el mayor candidato (suele ser el total)
      if (candidates.length) amount = Math.max(...candidates.filter(n => !Number.isNaN(n)));

      // Litros y precio: en tu ticket: PRECIO 1.389 CANTIDAD 53.30 IMPORTE 74.03
      let pricePerLiter = null;
      let liters = null;

      // Buscar patr√≥n: PRECIO ... CANTIDAD ... IMPORTE ...
      const mFuelLine = t.match(/PRECIO\s+(\d+\.\d{3})\s+(\d+\.\d{2})\s+(\d+\.\d{2})/i);
      if (mFuelLine) {
        pricePerLiter = Number(mFuelLine[1]);
        liters = Number(mFuelLine[2]);
        // mFuelLine[3] ser√≠a importe l√≠nea
      } else {
        // Alternativa: buscar "CANTIDAD" (litros) y "PRECIO" sueltos
        const mP = t.match(/\bPRECIO\b\s+(\d+\.\d{3})/i);
        const mL = t.match(/\bCANTIDAD\b\s+(\d+\.\d{2})/i);
        if (mP) pricePerLiter = Number(mP[1]);
        if (mL) liters = Number(mL[1]);
      }

      // Sugerencia m√©todo: si aparece CARREFOUR
      const suggestCarrefour = /CARREFOUR/i.test(t);

      return {
        date,
        amount,
        liters,
        pricePerLiter,
        suggestCarrefour
      };
    }

    function fileToDataURL(file) {
      return new Promise((resolve, reject) => {
        const r = new FileReader();
        r.onload = () => resolve(r.result);
        r.onerror = reject;
        r.readAsDataURL(file);
      });
    }

    function loadScript(src) {
      return new Promise((resolve, reject) => {
        const s = document.createElement("script");
        s.src = src;
        s.onload = resolve;
        s.onerror = reject;
        document.head.appendChild(s);
      });
    }

    // Demo r√°pido para probar sin OCR (rellena como tu ticket de Carrefour)
    function fillOcrDemo() {
      document.getElementById("category").value = "fuel";
      document.getElementById("paymentMethod").value = "carrefour";
      document.getElementById("amount").value = "74.03";
      document.getElementById("liters").value = "53.30";
      document.getElementById("pricePerLiter").value = "1.389";
      document.getElementById("description").value = "Repostaje Carrefour (demo)";
      onCategoryChange();
      updatePreview();
      setOcrStatus("Demo aplicada ‚úÖ (rellena kilometraje)", 100);
    }

    /******************************************************************
     * HELPERS
     ******************************************************************/
    function escapeHtml(str){
      return String(str ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    /******************************************************************
     * PWA
     ******************************************************************/
    let deferredPrompt;

    function registerServiceWorker() {
      if ("serviceWorker" in navigator) {
        navigator.serviceWorker.register("./sw.js")
          .then(() => {})
          .catch(() => {});
      }
    }

    function initInstallPrompt() {
      window.addEventListener("beforeinstallprompt", (e) => {
        e.preventDefault();
        deferredPrompt = e;
        document.getElementById("installBanner").classList.remove("hidden");
      });

      window.addEventListener("appinstalled", () => {
        deferredPrompt = null;
        document.getElementById("installBanner").classList.add("hidden");
      });
    }

    function installPWA() {
      if (!deferredPrompt) return;
      deferredPrompt.prompt();
      deferredPrompt.userChoice.finally(() => {
        deferredPrompt = null;
        document.getElementById("installBanner").classList.add("hidden");
      });
    }

    function closeInstallBanner() {
      document.getElementById("installBanner").classList.add("hidden");
    }

    /******************************************************************
     * INIT (IMPORTANT: NO OCR MODAL OPEN HERE)
     ******************************************************************/
    window.addEventListener("DOMContentLoaded", () => {
      loadAll();
      onCategoryChange();
      updatePreview();
      registerServiceWorker();
      initInstallPrompt();
      // NOTA: aqu√≠ NO se llama a openOcrModal() ni a OCR
    });
  </script>
</body>
</html>
