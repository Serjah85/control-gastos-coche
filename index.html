<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="Controla todos los gastos de tu coche: combustible, mantenimiento, ITV, seguro e impuestos. Calcula el coste real por kil√≥metro. Multi-a√±o y multi-coche. OCR de tickets." />
  <meta name="theme-color" content="#1e3c72" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Gastos Coche" />
  <link rel="manifest" href="./manifest.json" />
  <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Crect fill='%231e3c72' width='512' height='512'/%3E%3Ctext x='50%25' y='50%25' text-anchor='middle' dominant-baseline='central' font-size='300' fill='white'%3Eüöó%3C/text%3E%3C/svg%3E" />
  <title>Control Gastos Coche</title>

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .app-container { max-width: 1400px; margin: 0 auto; }

    .header {
      background: white;
      padding: 25px;
      border-radius: 12px;
      margin-bottom: 20px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    .header h1 { color: #1e3c72; font-size: 28px; margin-bottom: 5px; }
    .header p { color: #666; font-size: 14px; }

    .dashboard {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }

    .metric-card {
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      border-left: 4px solid;
    }
    .metric-card.total { border-left-color: #e74c3c; }
    .metric-card.cashback { border-left-color: #f39c12; }
    .metric-card.real { border-left-color: #27ae60; }
    .metric-card.km { border-left-color: #3498db; }
    .metric-card.cost-per-km { border-left-color: #9b59b6; }

    .metric-label {
      font-size: 12px;
      color: #666;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
    }

    .metric-value { font-size: 28px; font-weight: bold; color: #2c3e50; }
    .metric-value.positive { color: #27ae60; }

    .card {
      background: white;
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }

    .card h2 { color: #2c3e50; margin-bottom: 20px; font-size: 20px; }

    .form-group { margin-bottom: 15px; }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }

    label { display: block; margin-bottom: 5px; color: #555; font-size: 14px; font-weight: 500; }

    input, select, textarea {
      width: 100%;
      padding: 10px;
      border: 2px solid #e0e0e0;
      border-radius: 6px;
      font-size: 14px;
      transition: border-color 0.3s;
    }

    input:focus, select:focus, textarea:focus { outline: none; border-color: #3498db; }

    .category-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      color: white;
    }
    .category-fuel { background: #3498db; }
    .category-maintenance { background: #e67e22; }
    .category-itv { background: #27ae60; }
    .category-insurance { background: #9b59b6; }
    .category-tax { background: #34495e; }
    .category-other { background: #95a5a6; }

    .payment-method-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 600;
      margin-left: 8px;
    }
    .payment-ing { background: #ff6200; color: white; }
    .payment-carrefour { background: #0057a0; color: white; }
    .payment-bp { background: #009639; color: white; }
    .payment-repsol { background: #fbba00; color: #333; }
    .payment-moeve { background: #00aeef; color: white; }
    .payment-shell { background: #dd1d21; color: white; }
    .payment-other { background: #e0e0e0; color: #555; }

    button {
      background: #3498db;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.3s;
    }
    button:hover { background: #2980b9; }
    button.secondary { background: #95a5a6; }
    button.secondary:hover { background: #7f8c8d; }
    button.danger { background: #e74c3c; }
    button.danger:hover { background: #c0392b; }

    .button-group { display: flex; gap: 10px; margin-top: 20px; flex-wrap: wrap; }

    .expense-item {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 10px;
      border-left: 4px solid;
    }
    .expense-item.fuel { border-left-color: #3498db; }
    .expense-item.maintenance { border-left-color: #e67e22; }
    .expense-item.itv { border-left-color: #27ae60; }
    .expense-item.insurance { border-left-color: #9b59b6; }
    .expense-item.tax { border-left-color: #34495e; }
    .expense-item.other { border-left-color: #95a5a6; }

    .expense-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
      flex-wrap: wrap;
      gap: 10px;
    }
    .expense-date { font-size: 13px; color: #666; }
    .expense-amount { font-size: 18px; font-weight: bold; color: #2c3e50; }
    .expense-details { font-size: 13px; color: #555; margin-top: 8px; }
    .expense-actions { margin-top: 10px; display: flex; gap: 8px; }
    .expense-actions button { padding: 6px 12px; font-size: 12px; }

    .preview-box {
      background: #f0f7ff;
      border: 2px dashed #3498db;
      padding: 20px;
      border-radius: 8px;
      margin-top: 20px;
    }
    .preview-box h3 { color: #2c3e50; margin-bottom: 15px; font-size: 16px; }

    .preview-row {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid #ddd;
      gap: 10px;
    }
    .preview-row:last-child {
      border-bottom: none;
      font-weight: bold;
      font-size: 16px;
      color: #27ae60;
      padding-top: 12px;
      margin-top: 8px;
      border-top: 2px solid #27ae60;
    }

    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      border-bottom: 2px solid #e0e0e0;
      flex-wrap: wrap;
    }
    .tab {
      padding: 10px 20px;
      background: none;
      border: none;
      border-bottom: 3px solid transparent;
      cursor: pointer;
      color: #666;
      font-weight: 600;
      transition: all 0.3s;
    }
    .tab.active { color: #3498db; border-bottom-color: #3498db; }
    .tab:hover { color: #3498db; }

    .empty-state { text-align: center; padding: 40px; color: #999; }
    .empty-state-icon { font-size: 48px; margin-bottom: 16px; }

    .info-text { font-size: 12px; color: #666; margin-top: 5px; font-style: italic; }
    .hidden { display: none; }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 15px;
      margin-top: 20px;
    }
    .stat-box {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 8px;
      border-left: 4px solid #3498db;
    }
    .stat-box .label { font-size: 12px; color: #666; margin-bottom: 8px; text-transform: uppercase; }
    .stat-box .value { font-size: 24px; font-weight: bold; color: #2c3e50; }

    @media (max-width: 768px) {
      .form-row { grid-template-columns: 1fr; }
      .dashboard { grid-template-columns: 1fr; }
      .button-group { flex-direction: column; }
      .button-group button { width: 100%; }
    }

    input[type="file"] { display: none; }
    .file-upload-label { display: inline-block; }

    .footer {
      background: white;
      padding: 20px;
      border-radius: 12px;
      margin-top: 20px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      text-align: center;
    }
    .coffee-btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
      color: white;
      padding: 12px 24px;
      border-radius: 25px;
      text-decoration: none;
      font-weight: 600;
      font-size: 14px;
      transition: transform 0.2s, box-shadow 0.2s;
      box-shadow: 0 4px 8px rgba(243, 156, 18, 0.3);
    }
    .coffee-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(243, 156, 18, 0.4);
    }
    .footer-text { color: #666; font-size: 13px; margin-bottom: 15px; line-height: 1.6; }

    .install-banner {
      background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
      color: white;
      padding: 15px 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 15px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    .install-banner.hidden { display: none; }
    .install-banner-text { flex: 1; font-size: 14px; }
    .install-banner-btn {
      background: white;
      color: #3498db;
      padding: 8px 16px;
      border-radius: 6px;
      border: none;
      font-weight: 600;
      cursor: pointer;
      font-size: 13px;
      white-space: nowrap;
    }
    .install-banner-close {
      background: transparent;
      color: white;
      border: none;
      font-size: 20px;
      cursor: pointer;
      padding: 0 5px;
      opacity: 0.8;
    }
    .install-banner-close:hover { opacity: 1; }

    /* OCR MODAL */
    .ocr-modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.45);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      z-index: 9999;
    }
    .ocr-card {
      width: min(720px, 100%);
      background: white;
      border-radius: 12px;
      padding: 18px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.25);
    }
  </style>
</head>

<body>
  <div class="app-container">
    <div class="header">
      <h1>üöó Control de Gastos del Coche</h1>
      <p>
        Vista actual: <strong><span id="currentScopeLabel">‚Äî</span></strong> ¬∑ Kilometraje actual: <span id="currentKm">0</span> km
      </p>

      <div style="margin-top:12px; display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
        <select id="carSelect" onchange="onChangeCar()"></select>
        <select id="yearSelect" onchange="onChangeYear()"></select>
        <button type="button" class="secondary" onclick="addCarPrompt()">‚ûï A√±adir coche</button>
      </div>
      <div class="info-text" style="margin-top:10px;">
        Consejo: en un coche nuevo, crea el coche y pon un ‚Äúkilometraje base‚Äù para que el coste/km salga fino.
      </div>
    </div>

    <!-- Dashboard -->
    <div class="dashboard">
      <div class="metric-card total">
        <div class="metric-label">Total Pagado (Ticket)</div>
        <div class="metric-value" id="totalPaid">0.00 ‚Ç¨</div>
      </div>
      <div class="metric-card cashback">
        <div class="metric-label">Cashback/Puntos (a devolver)</div>
        <div class="metric-value positive" id="totalCashback">-0.00 ‚Ç¨</div>
      </div>
      <div class="metric-card real">
        <div class="metric-label">Coste Real Final</div>
        <div class="metric-value" id="realCost">0.00 ‚Ç¨</div>
      </div>
      <div class="metric-card km">
        <div class="metric-label">Kil√≥metros (scope)</div>
        <div class="metric-value" id="totalKm">0 km</div>
      </div>
      <div class="metric-card cost-per-km">
        <div class="metric-label">Coste por Km</div>
        <div class="metric-value" id="costPerKm">0.000 ‚Ç¨/km</div>
      </div>
    </div>

    <!-- Tabs y contenido -->
    <div class="card">
      <div class="tabs">
        <button class="tab active" onclick="showTab('add', this)">
          <span id="addTabLabel">‚ûï A√±adir Gasto</span>
        </button>
        <button class="tab" onclick="showTab('list', this)">üìã Lista de Gastos</button>
        <button class="tab" onclick="showTab('stats', this)">üìä Estad√≠sticas</button>
      </div>

      <!-- Formulario A√±adir/Editar -->
      <div id="tabAdd" class="tab-content">
        <form id="expenseForm" onsubmit="handleSubmit(event)">
          <div class="form-row">
            <div class="form-group">
              <label>Fecha</label>
              <input type="date" id="date" required />
            </div>
            <div class="form-group">
              <label>Categor√≠a</label>
              <select id="category" onchange="toggleFuelFields(); togglePromoFields(); updatePreview();">
                <option value="fuel">‚õΩ Combustible</option>
                <option value="maintenance">üîß Mantenimiento</option>
                <option value="itv">‚úÖ ITV</option>
                <option value="insurance">üõ°Ô∏è Seguro</option>
                <option value="tax">üìã Impuestos</option>
                <option value="other">üìå Otros</option>
              </select>
            </div>
          </div>

          <div class="form-group">
            <label>Descripci√≥n</label>
            <input type="text" id="description" placeholder="Ej: Repostaje Carrefour, Cambio aceite, etc." />
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>Importe Pagado (‚Ç¨) ‚Äî total del ticket</label>
              <input type="number" step="0.01" id="amount" required oninput="updatePreview()" />
            </div>
            <div class="form-group">
              <label>Kilometraje</label>
              <input type="number" id="odometer" required placeholder="Ej: 85432" />
            </div>
          </div>

          <!-- Campos espec√≠ficos de combustible -->
          <div id="fuelFields">
            <div class="form-row">
              <div class="form-group">
                <label>Litros</label>
                <input type="number" step="0.01" id="liters" placeholder="Ej: 45.50" oninput="updatePreview()" />
              </div>
              <div class="form-group">
                <label>Precio/Litro Visible (‚Ç¨)</label>
                <input type="number" step="0.001" id="pricePerLiter" placeholder="Ej: 1.459" oninput="updatePreview()" />
                <div class="info-text">Precio que aparece en el surtidor/ticket</div>
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label>Gasolinera / Proveedor</label>
                <select id="station" onchange="togglePromoFields(); updatePreview();">
                  <option value="other">Otro</option>
                  <option value="carrefour">Carrefour</option>
                  <option value="galp">Galp</option>
                  <option value="bp">BP</option>
                  <option value="repsol">Repsol</option>
                  <option value="moeve">MOEVE (Cepsa)</option>
                  <option value="shell">Shell</option>
                </select>
              </div>

              <div class="form-group" id="clubCarrefourWrap" style="display:none;">
                <label style="display:flex; gap:10px; align-items:center;">
                  <input type="checkbox" id="clubCarrefour" onchange="togglePromoFields(); updatePreview()" />
                  Club Carrefour (8% cheque ahorro)
                </label>
                <div class="info-text">Se calcula como cashback diferido autom√°tico</div>
              </div>
            </div>

            <div class="form-group" id="carrefourBaseWrap" style="display:none;">
              <label>Base carburante para 8% (‚Ç¨)</label>
              <input type="number" step="0.01" id="carrefourFuelBase" placeholder="D√©jalo vac√≠o si el ticket es solo carburante" oninput="updatePreview()" />
              <div class="info-text">Si el ticket incluye compras de tienda, pon aqu√≠ solo el importe del carburante.</div>
            </div>
          </div>

          <div class="form-group">
            <label>M√©todo de Pago</label>
            <select id="paymentMethod" onchange="updatePreview()">
              <option value="other">Otro</option>
              <option value="ing">ING (3% cashback en Galp)</option>
              <option value="carrefour">Tarjeta Carrefour</option>
              <option value="bp">BP Plus</option>
              <option value="repsol">Repsol Waylet</option>
              <option value="moeve">MOEVE Club</option>
              <option value="shell">Shell Smart</option>
            </select>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>Ahorro en ticket (informativo) (‚Ç¨)</label>
              <input type="number" step="0.01" id="ticketSavings" value="0" oninput="updatePreview()" />
              <div class="info-text">Descuento que aparece en el ticket (ya aplicado en el total). No altera el ‚Äúpagado‚Äù.</div>
            </div>
            <div class="form-group">
              <label>Cashback/Puntos manual (diferido) (‚Ç¨)</label>
              <input type="number" step="0.01" id="deferredCashbackManual" value="0" oninput="updatePreview()" />
              <div class="info-text">Puntos/cheque ahorro si quieres introducirlo t√∫ (si no, Carrefour 8% se calcula solo).</div>
            </div>
          </div>

          <div class="form-group">
            <label>Notas</label>
            <textarea id="notes" rows="3" placeholder="Cualquier anotaci√≥n adicional..."></textarea>
          </div>

          <!-- Vista previa -->
          <div id="previewBox" class="preview-box hidden">
            <h3>Vista Previa del Gasto</h3>
            <div id="previewContent"></div>
          </div>

          <div class="button-group">
            <button type="submit" id="submitBtn">‚ûï A√±adir Gasto</button>
            <button type="button" class="secondary" id="cancelBtn" onclick="cancelEdit()" style="display:none;">‚ùå Cancelar</button>

            <button type="button" class="secondary" onclick="openTicketScanner()">üì∑ Leer ticket (OCR)</button>
            <input type="file" id="ticketImage" accept="image/*" capture="environment" onchange="handleTicketImage(event)" style="display:none;" />

            <button type="button" class="secondary" onclick="exportToExcel()">üìä Exportar Excel</button>

            <label class="file-upload-label">
              <button type="button" class="secondary">üì• Importar Excel</button>
              <input type="file" id="importFile" accept=".xlsx,.xls" onchange="importFromExcel(event)" />
            </label>

            <button type="button" class="secondary" onclick="backupJSON()">üíæ Backup JSON</button>
            <button type="button" class="secondary" onclick="restoreJSON()">‚ôªÔ∏è Restaurar JSON</button>
          </div>
        </form>
      </div>

      <!-- Lista de gastos -->
      <div id="tabList" class="tab-content hidden">
        <div id="expensesList"></div>
      </div>

      <!-- Estad√≠sticas -->
      <div id="tabStats" class="tab-content hidden">
        <div id="statsContent"></div>
      </div>
    </div>

    <!-- Banner de instalaci√≥n PWA -->
    <div id="installBanner" class="install-banner hidden">
      <div class="install-banner-text">
        üì± <strong>Instala la app</strong> en tu m√≥vil para acceso r√°pido
      </div>
      <button class="install-banner-btn" onclick="installPWA()">Instalar</button>
      <button class="install-banner-close" onclick="closeInstallBanner()">√ó</button>
    </div>

    <!-- Footer con bot√≥n de caf√© -->
    <div class="footer">
      <div class="footer-text">
        ¬øTe est√° ayudando a ahorrar en gasolina? üöóüí∞<br />
        Si te resulta √∫til, puedes invitarme a un caf√©
      </div>
      <a href="https://paypal.me/perfectamaquinaria" target="_blank" class="coffee-btn" rel="noopener">
        ‚òï Inv√≠tame a un caf√©
      </a>
    </div>
  </div>

  <!-- OCR MODAL -->
  <div id="ocrModal" class="ocr-modal hidden">
    <div class="ocr-card">
      <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
        <h3 style="margin:0; color:#2c3e50;">üì∑ Lectura de ticket (OCR)</h3>
        <button type="button" class="secondary" onclick="closeOcrModal()">Cerrar</button>
      </div>

      <p style="margin-top:10px; color:#555; font-size:13px;">
        Se procesa <strong>en tu dispositivo</strong>. No se sube a Internet.
      </p>

      <div id="ocrProgressWrap" style="margin-top:12px;">
        <div style="font-size:13px; color:#555; margin-bottom:8px;">
          Estado: <span id="ocrStatus">Preparando...</span>
        </div>
        <div style="width:100%; height:10px; background:#e9ecef; border-radius:8px; overflow:hidden;">
          <div id="ocrProgressBar" style="height:10px; width:0%; background:#3498db;"></div>
        </div>
      </div>

      <div id="ocrPreviewWrap" style="margin-top:14px; display:none;">
        <img id="ocrPreview" alt="Ticket" style="max-width:100%; border-radius:8px; border:1px solid #e0e0e0;">
      </div>

      <div id="ocrResultWrap" style="margin-top:14px; display:none;">
        <div class="preview-box" style="margin-top:0;">
          <h3>Datos detectados</h3>
          <div id="ocrResult"></div>
        </div>

        <div class="button-group" style="margin-top:14px;">
          <button type="button" onclick="applyOcrResult()">‚úÖ Aplicar al formulario</button>
          <button type="button" class="secondary" onclick="openTicketScanner()">üîÑ Repetir</button>
        </div>

        <p style="margin-top:10px; color:#777; font-size:12px;">
          Revisa antes de guardar (los tickets t√©rmicos a veces salen borrosos).
        </p>
      </div>
    </div>
  </div>

  <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>

  <script>
    // =========================
    // CONFIG
    // =========================
    const CATEGORIES = {
      fuel: { label: "Combustible", color: "#3498db", icon: "‚õΩ" },
      maintenance: { label: "Mantenimiento", color: "#e67e22", icon: "üîß" },
      itv: { label: "ITV", color: "#27ae60", icon: "‚úÖ" },
      insurance: { label: "Seguro", color: "#9b59b6", icon: "üõ°Ô∏è" },
      tax: { label: "Impuestos", color: "#34495e", icon: "üìã" },
      other: { label: "Otros", color: "#95a5a6", icon: "üìå" }
    };

    const PAYMENT_METHODS = {
      ing: { label: "ING", color: "#ff6200" },
      carrefour: { label: "Carrefour", color: "#0057a0" },
      bp: { label: "BP Plus", color: "#009639" },
      repsol: { label: "Repsol Waylet", color: "#fbba00" },
      moeve: { label: "MOEVE Club", color: "#00aeef" },
      shell: { label: "Shell Smart", color: "#dd1d21" },
      other: { label: "Otro", color: "#95a5a6" }
    };

    const STATIONS = {
      carrefour: "Carrefour",
      galp: "Galp",
      bp: "BP",
      repsol: "Repsol",
      moeve: "MOEVE",
      shell: "Shell",
      other: "Otro"
    };

    // =========================
    // DB (multi-coche / multi-a√±o)
    // =========================
    const DB_KEY = "carExpenseTracker.v1";

    let db = {
      cars: [],               // [{id, name, baselineOdometer}]
      selectedCarId: null,
      selectedYear: "all",    // "all" o "2026"...
      expenses: []            // [{... , carId}]
    };

    let editingId = null;

    function uid() { return String(Date.now() + Math.random()); }

    function getYearFromDate(dateStr) {
      const d = new Date(dateStr);
      return isNaN(d) ? null : String(d.getFullYear());
    }

    function getSelectedCar() {
      return db.cars.find(c => c.id === db.selectedCarId) || null;
    }

    function getScopedExpenses() {
      const carId = db.selectedCarId;
      const year = db.selectedYear;

      let list = db.expenses.filter(e => e.carId === carId);
      if (year !== "all") list = list.filter(e => getYearFromDate(e.date) === year);

      list.sort((a,b) => new Date(b.date) - new Date(a.date));
      return list;
    }

    function saveDB() {
      localStorage.setItem(DB_KEY, JSON.stringify(db));
    }

    function loadDB() {
      const raw = localStorage.getItem(DB_KEY);
      if (raw) {
        db = JSON.parse(raw);
        if (!db.cars || !db.expenses) throw new Error("DB corrupta");
        if (!db.selectedCarId && db.cars.length) db.selectedCarId = db.cars[0].id;
        if (!db.selectedYear) db.selectedYear = "all";
        return;
      }

      // Migraci√≥n desde tu versi√≥n antigua (2026)
      const old = localStorage.getItem("carExpenses2026");
      if (old) {
        const car = { id: uid(), name: "Mi coche", baselineOdometer: 0 };
        const oldExpenses = JSON.parse(old).map(e => ({
          ...e,
          carId: car.id,
          station: e.station || "other",
          clubCarrefour: !!e.clubCarrefour,
          carrefourFuelBase: e.carrefourFuelBase || 0,
          ticketSavings: e.ticketSavings || e.immediateDiscount || 0,
          deferredCashbackManual: e.deferredCashbackManual || e.deferredCashback || 0
        }));

        db = { cars: [car], selectedCarId: car.id, selectedYear: "all", expenses: oldExpenses };
        saveDB();
        return;
      }

      // Primera instalaci√≥n
      const car = { id: uid(), name: "Mi coche", baselineOdometer: 0 };
      db = { cars: [car], selectedCarId: car.id, selectedYear: "all", expenses: [] };
      saveDB();
    }

    function renderCarSelect() {
      const sel = document.getElementById("carSelect");
      sel.innerHTML = db.cars.map(c => `<option value="${c.id}">${escapeHtml(c.name)}</option>`).join("");
      sel.value = db.selectedCarId;
    }

    function recomputeYearOptions() {
      const carId = db.selectedCarId;
      const years = new Set(
        db.expenses
          .filter(e => e.carId === carId)
          .map(e => getYearFromDate(e.date))
          .filter(Boolean)
      );

      const yearSelect = document.getElementById("yearSelect");
      const sorted = Array.from(years).sort((a,b) => b.localeCompare(a));
      yearSelect.innerHTML =
        `<option value="all">Todos los a√±os</option>` +
        sorted.map(y => `<option value="${y}">${y}</option>`).join("");

      if (db.selectedYear !== "all" && !years.has(db.selectedYear)) db.selectedYear = "all";
      yearSelect.value = db.selectedYear;

      updateScopeLabel();
    }

    function updateScopeLabel() {
      const car = getSelectedCar();
      const year = db.selectedYear === "all" ? "Todos los a√±os" : db.selectedYear;
      document.getElementById("currentScopeLabel").textContent = `${car ? car.name : "‚Äî"} ¬∑ ${year}`;
    }

    function onChangeCar() {
      db.selectedCarId = document.getElementById("carSelect").value;
      db.selectedYear = "all";
      saveDB();
      recomputeYearOptions();
      updateDashboard();
      renderExpensesList();
      renderStats();
    }

    function onChangeYear() {
      db.selectedYear = document.getElementById("yearSelect").value;
      saveDB();
      updateScopeLabel();
      updateDashboard();
      renderExpensesList();
      renderStats();
    }

    function addCarPrompt() {
      const name = prompt("Nombre del coche (ej: Auris, Coche Ver√≥nica, etc):");
      if (!name) return;

      const baseline = parseFloat(prompt("Kilometraje base (opcional, para coste/km):", "0")) || 0;
      const car = { id: uid(), name: name.trim(), baselineOdometer: baseline };

      db.cars.push(car);
      db.selectedCarId = car.id;
      db.selectedYear = "all";

      saveDB();
      renderCarSelect();
      recomputeYearOptions();
      updateDashboard();
      renderExpensesList();
      renderStats();
    }

    // =========================
    // PROMOS / CASHBACK
    // =========================
    // ING 3% SOLO si: fuel + station=galp + payment=ing
    function calcAutoCashback(amountTicket, category, station, paymentMethod) {
      if (category === "fuel" && station === "galp" && paymentMethod === "ing") {
        return amountTicket * 0.03;
      }
      return 0;
    }

    // Carrefour 8% diferido si: fuel + station=carrefour + clubCarrefour
    // Base = carrefourFuelBase si viene, si no total ticket
    function calcAutoDeferred(amountTicket, category, station, clubCarrefour, carrefourFuelBase) {
      if (category === "fuel" && station === "carrefour" && clubCarrefour) {
        const base = (typeof carrefourFuelBase === "number" && carrefourFuelBase > 0)
          ? carrefourFuelBase
          : amountTicket;
        return base * 0.08;
      }
      return 0;
    }

    function toggleFuelFields() {
      const category = document.getElementById("category").value;
      document.getElementById("fuelFields").style.display = category === "fuel" ? "block" : "none";
      if (category !== "fuel") {
        document.getElementById("station").value = "other";
        document.getElementById("clubCarrefour").checked = false;
        document.getElementById("carrefourFuelBase").value = "";
      }
      togglePromoFields();
    }

    function togglePromoFields() {
      const cat = document.getElementById("category").value;
      const st = document.getElementById("station").value;

      const clubWrap = document.getElementById("clubCarrefourWrap");
      const baseWrap = document.getElementById("carrefourBaseWrap");
      const club = document.getElementById("clubCarrefour");
      const baseInput = document.getElementById("carrefourFuelBase");

      const showCarrefourPromo = (cat === "fuel" && st === "carrefour");
      clubWrap.style.display = showCarrefourPromo ? "block" : "none";

      if (!showCarrefourPromo) {
        club.checked = false;
        baseWrap.style.display = "none";
        baseInput.value = "";
        return;
      }

      baseWrap.style.display = club.checked ? "block" : "none";
      if (!club.checked) baseInput.value = "";
    }

    // =========================
    // DASHBOARD
    // =========================
    function updateDashboard() {
      const list = getScopedExpenses();
      const car = getSelectedCar();

      const totalPaid = list.reduce((s, e) => s + (e.amount || 0), 0);
      const totalAuto = list.reduce((s, e) => s + calcAutoCashback(e.amount||0, e.category, e.station||"other", e.paymentMethod), 0);
      const totalDeferredAuto = list.reduce((s, e) => s + calcAutoDeferred(e.amount||0, e.category, e.station||"other", !!e.clubCarrefour, e.carrefourFuelBase||0), 0);
      const totalDeferredManual = list.reduce((s, e) => s + (e.deferredCashbackManual || 0), 0);

      const totalCashback = totalAuto + totalDeferredAuto + totalDeferredManual;
      const realCost = totalPaid - totalCashback;

      const odos = list.map(e => e.odometer || 0).filter(v => v > 0);
      const minOdo = odos.length ? Math.min(...odos) : 0;
      const maxOdo = odos.length ? Math.max(...odos) : 0;

      const baseline = (car && car.baselineOdometer > 0 && car.baselineOdometer <= maxOdo) ? car.baselineOdometer : minOdo;
      const totalKm = Math.max(0, maxOdo - baseline);
      const costPerKm = totalKm > 0 ? realCost / totalKm : 0;

      document.getElementById("currentKm").textContent = maxOdo ? maxOdo.toFixed(0) : "0";
      document.getElementById("totalPaid").textContent = totalPaid.toFixed(2) + " ‚Ç¨";
      document.getElementById("totalCashback").textContent = "-" + totalCashback.toFixed(2) + " ‚Ç¨";
      document.getElementById("realCost").textContent = realCost.toFixed(2) + " ‚Ç¨";
      document.getElementById("totalKm").textContent = totalKm.toFixed(0) + " km";
      document.getElementById("costPerKm").textContent = costPerKm.toFixed(3) + " ‚Ç¨/km";
    }

    // =========================
    // PREVIEW
    // =========================
    function updatePreview() {
      const amount = parseFloat(document.getElementById("amount").value) || 0;
      const category = document.getElementById("category").value;
      const station = document.getElementById("station").value;
      const paymentMethod = document.getElementById("paymentMethod").value;

      const ticketSavings = parseFloat(document.getElementById("ticketSavings").value) || 0; // info only
      const deferredManual = parseFloat(document.getElementById("deferredCashbackManual").value) || 0;

      const clubCarrefour = document.getElementById("clubCarrefour").checked;
      const carrefourBase = parseFloat(document.getElementById("carrefourFuelBase").value) || 0;

      const liters = parseFloat(document.getElementById("liters").value) || 0;

      if (amount <= 0) {
        document.getElementById("previewBox").classList.add("hidden");
        return;
      }

      // Cashback real (reduce coste): ING Galp + Carrefour 8% + manual
      const autoCash = calcAutoCashback(amount, category, station, paymentMethod);
      const autoDeferred = calcAutoDeferred(amount, category, station, clubCarrefour, carrefourBase);
      const totalCashback = autoCash + autoDeferred + deferredManual;
      const realCost = amount - totalCashback;

      let html = `
        <div class="preview-row">
          <span>Importe pagado (ticket):</span>
          <span>${amount.toFixed(2)} ‚Ç¨</span>
        </div>
      `;

      if (ticketSavings > 0) {
        html += `
          <div class="preview-row">
            <span>Ahorro en ticket (informativo):</span>
            <span>‚âà ${ticketSavings.toFixed(2)} ‚Ç¨</span>
          </div>
        `;
      }

      if (autoDeferred > 0) {
        html += `
          <div class="preview-row">
            <span>- Carrefour Club (8% diferido):</span>
            <span>-${autoDeferred.toFixed(2)} ‚Ç¨</span>
          </div>
        `;
      }

      if (autoCash > 0) {
        html += `
          <div class="preview-row">
            <span>- Cashback ING (3% Galp):</span>
            <span>-${autoCash.toFixed(2)} ‚Ç¨</span>
          </div>
        `;
      }

      if (deferredManual > 0) {
        html += `
          <div class="preview-row">
            <span>- Cashback/Puntos manual (diferido):</span>
            <span>-${deferredManual.toFixed(2)} ‚Ç¨</span>
          </div>
        `;
      }

      html += `
        <div class="preview-row">
          <span><strong>Coste Real (pagado - devoluciones):</strong></span>
          <span><strong>${realCost.toFixed(2)} ‚Ç¨</strong></span>
        </div>
      `;

      if (category === "fuel" && liters > 0) {
        const realPricePerLiter = realCost / liters;
        html += `
          <div class="preview-row">
            <span>Precio real por litro:</span>
            <span>${realPricePerLiter.toFixed(3)} ‚Ç¨/L</span>
          </div>
        `;
      }

      document.getElementById("previewContent").innerHTML = html;
      document.getElementById("previewBox").classList.remove("hidden");
    }

    // =========================
    // TABS
    // =========================
    function showTab(tabName, btn) {
      document.querySelectorAll(".tab-content").forEach(t => t.classList.add("hidden"));
      document.querySelectorAll(".tab").forEach(b => b.classList.remove("active"));

      const tabId = "tab" + tabName.charAt(0).toUpperCase() + tabName.slice(1);
      document.getElementById(tabId).classList.remove("hidden");
      if (btn) btn.classList.add("active");

      if (tabName === "stats") renderStats();
    }

    // =========================
    // CRUD
    // =========================
    function handleSubmit(event) {
      event.preventDefault();

      const category = document.getElementById("category").value;

      const formData = {
        carId: db.selectedCarId,
        date: document.getElementById("date").value,
        category,
        description: document.getElementById("description").value || "",
        amount: parseFloat(document.getElementById("amount").value),
        odometer: parseFloat(document.getElementById("odometer").value),
        station: category === "fuel" ? document.getElementById("station").value : "other",
        clubCarrefour: category === "fuel" ? !!document.getElementById("clubCarrefour").checked : false,
        carrefourFuelBase: category === "fuel" ? (parseFloat(document.getElementById("carrefourFuelBase").value) || 0) : 0,
        paymentMethod: document.getElementById("paymentMethod").value,
        ticketSavings: parseFloat(document.getElementById("ticketSavings").value) || 0,
        deferredCashbackManual: parseFloat(document.getElementById("deferredCashbackManual").value) || 0,
        liters: category === "fuel" ? (parseFloat(document.getElementById("liters").value) || 0) : 0,
        pricePerLiter: category === "fuel" ? (parseFloat(document.getElementById("pricePerLiter").value) || 0) : 0,
        notes: document.getElementById("notes").value || ""
      };

      // Validaciones m√≠nimas
      if (!formData.date) return alert("Falta la fecha.");
      if (!isFinite(formData.amount) || formData.amount <= 0) return alert("Importe inv√°lido.");
      if (!isFinite(formData.odometer) || formData.odometer <= 0) return alert("Kilometraje inv√°lido.");
      if (formData.deferredCashbackManual < 0) return alert("El cashback manual no puede ser negativo.");
      if (formData.ticketSavings < 0) return alert("El ahorro en ticket no puede ser negativo.");

      if (editingId !== null) {
        const idx = db.expenses.findIndex(e => e.id === editingId);
        if (idx >= 0) db.expenses[idx] = { ...db.expenses[idx], ...formData, updatedAt: new Date().toISOString() };
        editingId = null;
      } else {
        formData.id = Number(Date.now());
        formData.createdAt = new Date().toISOString();
        db.expenses.push(formData);
      }

      saveDB();
      recomputeYearOptions();
      updateDashboard();
      renderExpensesList();
      renderStats();
      resetForm();
    }

    function resetForm() {
      document.getElementById("expenseForm").reset();
      document.getElementById("date").valueAsDate = new Date();
      document.getElementById("category").value = "fuel";
      document.getElementById("station").value = "other";
      document.getElementById("paymentMethod").value = "other";
      document.getElementById("ticketSavings").value = "0";
      document.getElementById("deferredCashbackManual").value = "0";
      document.getElementById("clubCarrefour").checked = false;
      document.getElementById("carrefourFuelBase").value = "";

      document.getElementById("previewBox").classList.add("hidden");
      document.getElementById("submitBtn").textContent = "‚ûï A√±adir Gasto";
      document.getElementById("addTabLabel").textContent = "‚ûï A√±adir Gasto";
      document.getElementById("cancelBtn").style.display = "none";
      editingId = null;

      toggleFuelFields();
      togglePromoFields();
    }

    function editExpense(id) {
      const e = db.expenses.find(x => x.id === id);
      if (!e) return;

      // Solo dejamos editar dentro del coche actual (si no, cambiamos autom√°ticamente)
      if (e.carId !== db.selectedCarId) {
        db.selectedCarId = e.carId;
        db.selectedYear = "all";
        saveDB();
        renderCarSelect();
        recomputeYearOptions();
      }

      editingId = id;

      document.getElementById("date").value = e.date;
      document.getElementById("category").value = e.category;
      document.getElementById("description").value = e.description || "";
      document.getElementById("amount").value = e.amount;
      document.getElementById("odometer").value = e.odometer;

      document.getElementById("station").value = e.station || "other";
      document.getElementById("clubCarrefour").checked = !!e.clubCarrefour;
      document.getElementById("carrefourFuelBase").value = e.carrefourFuelBase ? String(e.carrefourFuelBase) : "";

      document.getElementById("paymentMethod").value = e.paymentMethod || "other";
      document.getElementById("ticketSavings").value = e.ticketSavings || 0;
      document.getElementById("deferredCashbackManual").value = e.deferredCashbackManual || 0;

      document.getElementById("liters").value = e.liters ? String(e.liters) : "";
      document.getElementById("pricePerLiter").value = e.pricePerLiter ? String(e.pricePerLiter) : "";
      document.getElementById("notes").value = e.notes || "";

      document.getElementById("submitBtn").textContent = "‚úÖ Actualizar Gasto";
      document.getElementById("addTabLabel").textContent = "‚úèÔ∏è Editar Gasto";
      document.getElementById("cancelBtn").style.display = "inline-block";

      toggleFuelFields();
      togglePromoFields();
      updatePreview();
      showTab("add", document.querySelectorAll(".tab")[0]);
    }

    function cancelEdit() { resetForm(); }

    function deleteExpense(id) {
      if (!confirm("¬øSeguro que quieres eliminar este gasto?")) return;
      db.expenses = db.expenses.filter(e => e.id !== id);
      saveDB();
      recomputeYearOptions();
      updateDashboard();
      renderExpensesList();
      renderStats();
    }

    // =========================
    // LISTA
    // =========================
    function renderExpensesList() {
      const container = document.getElementById("expensesList");
      const list = getScopedExpenses();

      if (list.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">üìù</div>
            <p>No hay gastos en este coche/a√±o</p>
          </div>
        `;
        return;
      }

      container.innerHTML = list.map(e => {
        const cat = CATEGORIES[e.category] || CATEGORIES.other;
        const method = PAYMENT_METHODS[e.paymentMethod] || PAYMENT_METHODS.other;

        const autoCash = calcAutoCashback(e.amount||0, e.category, e.station||"other", e.paymentMethod);
        const autoDeferred = calcAutoDeferred(e.amount||0, e.category, e.station||"other", !!e.clubCarrefour, e.carrefourFuelBase||0);
        const manualDeferred = e.deferredCashbackManual || 0;

        const totalCashback = autoCash + autoDeferred + manualDeferred;
        const realCost = (e.amount || 0) - totalCashback;

        let details = `
          üí≥ Ticket: ${Number(e.amount||0).toFixed(2)} ‚Ç¨ |
          üí∞ Devoluci√≥n: -${totalCashback.toFixed(2)} ‚Ç¨ |
          ‚úÖ Real: ${realCost.toFixed(2)} ‚Ç¨
        `;

        if ((e.ticketSavings || 0) > 0) {
          details += `<br>üè∑Ô∏è Ahorro ticket (info): ‚âà ${Number(e.ticketSavings).toFixed(2)} ‚Ç¨`;
        }

        if (e.category === "fuel" && (e.liters || 0) > 0) {
          const liters = Number(e.liters||0);
          const pplVisible = Number(e.pricePerLiter||0);
          const pplReal = liters > 0 ? (realCost / liters) : 0;

          details += `<br>‚õΩ ${liters.toFixed(2)} L`;
          if (pplVisible > 0) details += ` | Visible: ${pplVisible.toFixed(3)} ‚Ç¨/L`;
          details += ` | Real: ${pplReal.toFixed(3)} ‚Ç¨/L`;

          const st = STATIONS[e.station] || "Otro";
          details += `<br>üè™ ${st}`;
          if (e.station === "carrefour" && e.clubCarrefour) {
            const base = (e.carrefourFuelBase || 0) > 0 ? e.carrefourFuelBase : e.amount;
            details += ` | Carrefour 8% sobre ${Number(base).toFixed(2)} ‚Ç¨`;
          }
          if (e.station === "galp" && e.paymentMethod === "ing") {
            details += ` | ING 3% (Galp)`;
          }
        }

        return `
          <div class="expense-item ${escapeHtml(e.category)}">
            <div class="expense-header">
              <div>
                <span class="category-badge category-${escapeHtml(e.category)}">${cat.icon} ${escapeHtml(cat.label)}</span>
                <span class="payment-method-badge payment-${escapeHtml(e.paymentMethod)}">${escapeHtml(method.label)}</span>
              </div>
              <div class="expense-amount">${realCost.toFixed(2)} ‚Ç¨</div>
            </div>

            <div class="expense-date">üìÖ ${escapeHtml(e.date)} | üõ£Ô∏è ${Number(e.odometer||0).toFixed(0)} km</div>

            ${e.description ? `<div class="expense-details"><strong>${escapeHtml(e.description)}</strong></div>` : ""}

            <div class="expense-details">${details}</div>

            ${e.notes ? `<div class="expense-details" style="font-style: italic; margin-top: 8px;">üìù ${escapeHtml(e.notes)}</div>` : ""}

            <div class="expense-actions">
              <button class="secondary" onclick="editExpense(${e.id})">‚úèÔ∏è Editar</button>
              <button class="danger" onclick="deleteExpense(${e.id})">üóëÔ∏è Eliminar</button>
            </div>
          </div>
        `;
      }).join("");
    }

    // =========================
    // STATS
    // =========================
    function renderStats() {
      const container = document.getElementById("statsContent");
      const list = getScopedExpenses();

      if (list.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">üìä</div>
            <p>No hay datos suficientes en este coche/a√±o</p>
          </div>
        `;
        return;
      }

      const totalPaid = list.reduce((s,e) => s + (e.amount||0), 0);
      const totalAuto = list.reduce((s,e) => s + calcAutoCashback(e.amount||0, e.category, e.station||"other", e.paymentMethod), 0);
      const totalDeferredAuto = list.reduce((s,e) => s + calcAutoDeferred(e.amount||0, e.category, e.station||"other", !!e.clubCarrefour, e.carrefourFuelBase||0), 0);
      const totalDeferredManual = list.reduce((s,e) => s + (e.deferredCashbackManual||0), 0);

      const totalCashback = totalAuto + totalDeferredAuto + totalDeferredManual;
      const realCost = totalPaid - totalCashback;

      const avgExpense = realCost / list.length;
      const cashbackPercent = totalPaid > 0 ? (totalCashback / totalPaid) * 100 : 0;

      const totalTicketSavings = list.reduce((s,e) => s + (e.ticketSavings||0), 0);

      // Por categor√≠a (coste real)
      const byCategory = Object.keys(CATEGORIES).map(key => {
        const subset = list.filter(e => e.category === key);
        if (!subset.length) return null;

        const subtotalPaid = subset.reduce((s,e) => s + (e.amount||0), 0);
        const subAuto = subset.reduce((s,e) => s + calcAutoCashback(e.amount||0, e.category, e.station||"other", e.paymentMethod), 0);
        const subDeferredAuto = subset.reduce((s,e) => s + calcAutoDeferred(e.amount||0, e.category, e.station||"other", !!e.clubCarrefour, e.carrefourFuelBase||0), 0);
        const subManual = subset.reduce((s,e) => s + (e.deferredCashbackManual||0), 0);
        const subReal = subtotalPaid - (subAuto + subDeferredAuto + subManual);

        return { key, category: CATEGORIES[key], count: subset.length, totalReal: subReal };
      }).filter(Boolean);

      // Combustible stats
      const fuels = list.filter(e => e.category === "fuel" && (e.liters||0) > 0);
      const totalLiters = fuels.reduce((s,e) => s + (e.liters||0), 0);

      const avgFuelPriceReal = fuels.length ? (fuels.reduce((s,e) => {
        const auto = calcAutoCashback(e.amount||0, e.category, e.station||"other", e.paymentMethod);
        const defAuto = calcAutoDeferred(e.amount||0, e.category, e.station||"other", !!e.clubCarrefour, e.carrefourFuelBase||0);
        const manual = e.deferredCashbackManual||0;
        const real = (e.amount||0) - (auto+defAuto+manual);
        return s + (e.liters > 0 ? (real / e.liters) : 0);
      },0) / fuels.length) : 0;

      let html = `
        <h3>Estad√≠sticas Generales</h3>
        <div class="stats-grid">
          <div class="stat-box">
            <div class="label">Gastos Registrados</div>
            <div class="value">${list.length}</div>
          </div>

          <div class="stat-box">
            <div class="label">Gasto Medio (Real)</div>
            <div class="value">${avgExpense.toFixed(2)} ‚Ç¨</div>
          </div>

          <div class="stat-box">
            <div class="label">% Cashback / Devoluciones</div>
            <div class="value">${cashbackPercent.toFixed(1)}%</div>
          </div>

          <div class="stat-box">
            <div class="label">Ahorro en ticket (info)</div>
            <div class="value">‚âà ${totalTicketSavings.toFixed(2)} ‚Ç¨</div>
          </div>

          ${fuels.length ? `
            <div class="stat-box">
              <div class="label">Repostajes</div>
              <div class="value">${fuels.length}</div>
            </div>
            <div class="stat-box">
              <div class="label">Litros totales</div>
              <div class="value">${totalLiters.toFixed(2)} L</div>
            </div>
            <div class="stat-box">
              <div class="label">Precio medio real</div>
              <div class="value">${avgFuelPriceReal.toFixed(3)} ‚Ç¨/L</div>
            </div>
          ` : ``}
        </div>

        <h3 style="margin-top: 30px;">Por Categor√≠a (Coste Real)</h3>
        <div class="stats-grid">
          ${byCategory.map(item => `
            <div class="stat-box" style="border-left-color:${item.category.color}">
              <div class="label">${item.category.icon} ${escapeHtml(item.category.label)}</div>
              <div class="value">${item.totalReal.toFixed(2)} ‚Ç¨</div>
              <div class="info-text">${item.count} gasto${item.count !== 1 ? "s" : ""}</div>
            </div>
          `).join("")}
        </div>
      `;

      container.innerHTML = html;
    }

    // =========================
    // EXPORT / IMPORT (Excel)
    // =========================
    function exportToExcel() {
      if (!window.XLSX) {
        alert("La librer√≠a de Excel no est√° cargada. Recarga la p√°gina.");
        return;
      }

      const wb = XLSX.utils.book_new();
      const list = getScopedExpenses();
      const car = getSelectedCar();
      const year = db.selectedYear;

      const rows = list.map(e => {
        const autoCash = calcAutoCashback(e.amount||0, e.category, e.station||"other", e.paymentMethod);
        const autoDeferred = calcAutoDeferred(e.amount||0, e.category, e.station||"other", !!e.clubCarrefour, e.carrefourFuelBase||0);
        const manual = e.deferredCashbackManual||0;

        const totalCashback = autoCash + autoDeferred + manual;
        const real = (e.amount||0) - totalCashback;

        return {
          "Coche": car ? car.name : "",
          "Fecha": e.date,
          "Categor√≠a": (CATEGORIES[e.category] || CATEGORIES.other).label,
          "Descripci√≥n": e.description || "",
          "Kilometraje": e.odometer,
          "Importe Ticket": Number(e.amount||0).toFixed(2),
          "Estaci√≥n": STATIONS[e.station] || "Otro",
          "M√©todo Pago": (PAYMENT_METHODS[e.paymentMethod] || PAYMENT_METHODS.other).label,
          "Club Carrefour": e.clubCarrefour ? "S√≠" : "No",
          "Base 8% Carrefour": e.carrefourFuelBase || "",
          "Ahorro Ticket (info)": Number(e.ticketSavings||0).toFixed(2),
          "Cashback Manual (diferido)": Number(manual).toFixed(2),
          "Cashback ING (auto)": Number(autoCash).toFixed(2),
          "Carrefour 8% (auto)": Number(autoDeferred).toFixed(2),
          "Cashback Total": Number(totalCashback).toFixed(2),
          "Coste Real": Number(real).toFixed(2),
          "Litros": e.liters || "",
          "Precio/L Visible": e.pricePerLiter || "",
          "Precio/L Real": (e.liters > 0 ? (real / e.liters).toFixed(3) : ""),
          "Notas": e.notes || ""
        };
      });

      const ws = XLSX.utils.json_to_sheet(rows);
      XLSX.utils.book_append_sheet(wb, ws, "Gastos");

      const fecha = new Date().toISOString().split("T")[0];
      const scopeYear = year === "all" ? "ALL" : year;
      const safeCar = (car ? car.name : "COCHE").replace(/[^\w\-]+/g, "_");
      XLSX.writeFile(wb, `Gastos_${safeCar}_${scopeYear}_${fecha}.xlsx`);
    }

    function importFromExcel(event) {
      const file = event.target.files && event.target.files[0];
      event.target.value = "";
      if (!file || !window.XLSX) return;

      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const data = new Uint8Array(e.target.result);
          const wb = XLSX.read(data, { type: "array" });
          const wsname = wb.SheetNames[0];
          const ws = wb.Sheets[wsname];
          const dataRows = XLSX.utils.sheet_to_json(ws);

          if (!dataRows.length) return alert("El Excel est√° vac√≠o.");

          // Importamos al coche seleccionado por defecto.
          // Si el excel trae columna "Coche", intentamos mapear/crear.
          const imported = dataRows.map(row => {
            const carName = String(row["Coche"] || "").trim();
            let carId = db.selectedCarId;

            if (carName) {
              const existing = db.cars.find(c => c.name.toLowerCase() === carName.toLowerCase());
              if (existing) carId = existing.id;
              else {
                const newCar = { id: uid(), name: carName, baselineOdometer: 0 };
                db.cars.push(newCar);
                carId = newCar.id;
              }
            }

            const catLabel = String(row["Categor√≠a"] || "").trim();
            const category = Object.keys(CATEGORIES).find(k => CATEGORIES[k].label === catLabel) || "other";

            const stationLabel = String(row["Estaci√≥n"] || "").trim().toLowerCase();
            const station = Object.keys(STATIONS).find(k => STATIONS[k].toLowerCase() === stationLabel) || "other";

            const payLabel = String(row["M√©todo Pago"] || "").trim();
            const paymentMethod = Object.keys(PAYMENT_METHODS).find(k => PAYMENT_METHODS[k].label === payLabel) || "other";

            const club = String(row["Club Carrefour"] || "").toLowerCase().startsWith("s");

            return {
              id: Number(Date.now() + Math.random()),
              carId,
              date: row["Fecha"] ? String(row["Fecha"]).slice(0,10) : "",
              category,
              description: row["Descripci√≥n"] || "",
              odometer: parseFloat(row["Kilometraje"] || 0) || 0,
              amount: parseFloat(row["Importe Ticket"] || 0) || 0,
              station,
              paymentMethod,
              clubCarrefour: !!club,
              carrefourFuelBase: parseFloat(row["Base 8% Carrefour"] || 0) || 0,
              ticketSavings: parseFloat(row["Ahorro Ticket (info)"] || 0) || 0,
              deferredCashbackManual: parseFloat(row["Cashback Manual (diferido)"] || 0) || 0,
              liters: parseFloat(row["Litros"] || 0) || 0,
              pricePerLiter: parseFloat(row["Precio/L Visible"] || 0) || 0,
              notes: row["Notas"] || "",
              createdAt: new Date().toISOString()
            };
          });

          // Merge
          db.expenses = [...imported, ...db.expenses];
          saveDB();

          renderCarSelect();
          recomputeYearOptions();
          updateDashboard();
          renderExpensesList();
          renderStats();

          alert(`${imported.length} gastos importados correctamente.`);
        } catch (err) {
          console.error(err);
          alert("Error al importar. Aseg√∫rate de que sea un Excel v√°lido (preferiblemente exportado desde esta app).");
        }
      };
      reader.readAsArrayBuffer(file);
    }

    // =========================
    // BACKUP / RESTORE (JSON)
    // =========================
    function backupJSON() {
      const blob = new Blob([JSON.stringify(db, null, 2)], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      const fecha = new Date().toISOString().split("T")[0];
      a.href = url;
      a.download = `GastosCoche_Backup_${fecha}.json`;
      a.click();
      URL.revokeObjectURL(url);
    }

    function restoreJSON() {
      const input = document.createElement("input");
      input.type = "file";
      input.accept = ".json,application/json";
      input.onchange = () => {
        const file = input.files && input.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = () => {
          try {
            const parsed = JSON.parse(reader.result);
            if (!parsed || !Array.isArray(parsed.cars) || !Array.isArray(parsed.expenses)) {
              return alert("JSON inv√°lido.");
            }
            db = parsed;
            if (!db.selectedCarId && db.cars.length) db.selectedCarId = db.cars[0].id;
            if (!db.selectedYear) db.selectedYear = "all";
            saveDB();

            renderCarSelect();
            recomputeYearOptions();
            updateDashboard();
            renderExpensesList();
            renderStats();

            alert("Restauraci√≥n completada ‚úÖ");
          } catch (e) {
            alert("No se pudo restaurar el JSON.");
          }
        };
        reader.readAsText(file);
      };
      input.click();
    }

    // =========================
    // UTIL
    // =========================
    function escapeHtml(str) {
      return String(str ?? "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;");
    }

    // =========================
    // PWA
    // =========================
    let deferredPrompt;

    function registerServiceWorker() {
      if ("serviceWorker" in navigator) {
        navigator.serviceWorker.register("./sw.js")
          .then(reg => console.log("SW registrado", reg))
          .catch(err => console.log("Error SW", err));
      }
    }

    function initInstallPrompt() {
      window.addEventListener("beforeinstallprompt", (e) => {
        e.preventDefault();
        deferredPrompt = e;
        document.getElementById("installBanner").classList.remove("hidden");
      });

      window.addEventListener("appinstalled", () => {
        document.getElementById("installBanner").classList.add("hidden");
        deferredPrompt = null;
      });
    }

    function installPWA() {
      if (!deferredPrompt) return;
      deferredPrompt.prompt();
      deferredPrompt.userChoice.finally(() => {
        deferredPrompt = null;
        document.getElementById("installBanner").classList.add("hidden");
      });
    }

    function closeInstallBanner() {
      document.getElementById("installBanner").classList.add("hidden");
    }

    // =========================
    // OCR (Tesseract.js lazy-load)
    // =========================
    let lastOcrResult = null;

    function openTicketScanner() {
      document.getElementById("ticketImage").click();
    }

    function openOcrModal() {
      document.getElementById("ocrModal").classList.remove("hidden");
      document.getElementById("ocrStatus").textContent = "Preparando...";
      document.getElementById("ocrProgressBar").style.width = "0%";
      document.getElementById("ocrPreviewWrap").style.display = "none";
      document.getElementById("ocrResultWrap").style.display = "none";
      lastOcrResult = null;
    }

    function closeOcrModal() {
      document.getElementById("ocrModal").classList.add("hidden");
    }

    function setOcrProgress(pct, status) {
      if (typeof pct === "number") {
        const clamped = Math.max(0, Math.min(100, pct));
        document.getElementById("ocrProgressBar").style.width = clamped + "%";
      }
      if (status) document.getElementById("ocrStatus").textContent = status;
    }

    function loadTesseract() {
      return new Promise((resolve, reject) => {
        if (window.Tesseract) return resolve(window.Tesseract);
        const s = document.createElement("script");
        s.src = "https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js";
        s.onload = () => resolve(window.Tesseract);
        s.onerror = () => reject(new Error("No se pudo cargar Tesseract.js"));
        document.head.appendChild(s);
      });
    }

    async function handleTicketImage(event) {
      const file = event.target.files && event.target.files[0];
      event.target.value = "";
      if (!file) return;

      openOcrModal();

      const url = URL.createObjectURL(file);
      const imgEl = document.getElementById("ocrPreview");
      imgEl.src = url;
      document.getElementById("ocrPreviewWrap").style.display = "block";

      try {
        setOcrProgress(5, "Cargando OCR...");
        const Tesseract = await loadTesseract();

        setOcrProgress(10, "Preparando imagen...");
        await waitImageLoad(imgEl);
        const processedDataUrl = await preprocessImageForOcr(imgEl);

        setOcrProgress(15, "Leyendo texto...");
        const { data } = await Tesseract.recognize(processedDataUrl, "spa", {
          logger: m => {
            if (m.status === "recognizing text") {
              setOcrProgress(15 + Math.round((m.progress || 0) * 80), "Reconociendo texto...");
            }
          }
        });

        setOcrProgress(95, "Analizando ticket...");
        const parsed = parseTicketText(data.text || "");
        parsed._validation = validateParsedTicket(parsed);

        setOcrProgress(100, "Listo ‚úÖ");
        lastOcrResult = parsed;

        renderOcrResult(parsed, data.text || "");
        document.getElementById("ocrResultWrap").style.display = "block";
      } catch (err) {
        console.error(err);
        alert("No se pudo leer el ticket. Prueba con m√°s luz, sin sombras, y el ticket plano.");
        closeOcrModal();
      } finally {
        URL.revokeObjectURL(url);
      }
    }

    function waitImageLoad(imgEl) {
      return new Promise((resolve, reject) => {
        if (imgEl.complete && imgEl.naturalWidth) return resolve();
        imgEl.onload = () => resolve();
        imgEl.onerror = () => reject(new Error("Error cargando imagen"));
      });
    }

    async function preprocessImageForOcr(imgEl) {
      const canvas = document.createElement("canvas");
      const ctx = canvas.getContext("2d", { willReadFrequently: true });

      const w = imgEl.naturalWidth || imgEl.width;
      const h = imgEl.naturalHeight || imgEl.height;

      const scale = 2;
      canvas.width = Math.round(w * scale);
      canvas.height = Math.round(h * scale);

      ctx.imageSmoothingEnabled = true;
      ctx.imageSmoothingQuality = "high";

      ctx.filter = "grayscale(1) contrast(1.6) brightness(1.05)";
      ctx.drawImage(imgEl, 0, 0, canvas.width, canvas.height);

      const imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);
      const data = imgData.data;

      // umbral din√°mico
      let sum = 0;
      const n = data.length / 4;
      for (let i = 0; i < data.length; i += 4) {
        const lum = data[i] * 0.299 + data[i + 1] * 0.587 + data[i + 2] * 0.114;
        sum += lum;
      }
      const mean = sum / n;
      const threshold = Math.max(90, Math.min(200, mean * 0.95));

      for (let i = 0; i < data.length; i += 4) {
        const lum = data[i];
        const v = lum > threshold ? 255 : 0;
        data[i] = data[i + 1] = data[i + 2] = v;
      }

      ctx.putImageData(imgData, 0, 0);
      return canvas.toDataURL("image/png");
    }

    function parseTicketText(raw) {
      const text = (raw || "")
        .replace(/\r/g, "\n")
        .replace(/[ \t]+/g, " ")
        .replace(/\n{2,}/g, "\n")
        .trim();

      const out = {
        dateISO: null,
        total: null,
        liters: null,
        pricePerLiter: null,
        station: "other",
        carrefourAccum: null,
        confidenceNotes: []
      };

      const upper = text.toUpperCase();
      if (upper.includes("CARREFOUR")) out.station = "carrefour";
      else if (upper.includes("GALP")) out.station = "galp";
      else if (upper.includes("REPSOL")) out.station = "repsol";
      else if (upper.includes("CEPSA") || upper.includes("MOEVE")) out.station = "moeve";
      else if (upper.includes("SHELL")) out.station = "shell";
      else if (upper.includes(" BP")) out.station = "bp";

      // Fecha (08.01.26 / 08/01/26 / 08-01-2026)
      const dateMatch = text.match(/(?:FECHA[: ]*)?(\d{2})[\/\.\-](\d{2})[\/\.\-](\d{2,4})/i);
      if (dateMatch) {
        const dd = dateMatch[1];
        const mm = dateMatch[2];
        let yy = dateMatch[3];
        if (yy.length === 2) yy = "20" + yy;
        out.dateISO = `${yy}-${mm}-${dd}`;
      } else {
        out.confidenceNotes.push("No he encontrado la fecha con claridad.");
      }

      // Total ticket
      const totalMatch =
        text.match(/TOTAL\s+EUROS[: ]+(\d+[.,]\d{2})/i) ||
        text.match(/IMPORTE[: ]+(\d+[.,]\d{2})/i);

      if (totalMatch) out.total = parseEuroNumber(totalMatch[1]);
      else out.confidenceNotes.push("No he encontrado el total con claridad.");

      // L√≠nea carburante con 3 n√∫meros: ‚Ç¨/L (3 decimales), litros (2), importe (2)
      const fuelLine = text.split("\n").find(line => {
        const u = line.toUpperCase();
        return (u.includes("GASOLEO") || u.includes("GASOLINA") || u.includes("DIESEL") || u.includes("AUTO")) &&
               /(\d+[.,]\d{3})\s+(\d+[.,]\d{2})\s+(\d+[.,]\d{2})/.test(line);
      });

      if (fuelLine) {
        const m = fuelLine.match(/(\d+[.,]\d{3})\s+(\d+[.,]\d{2})\s+(\d+[.,]\d{2})/);
        if (m) {
          out.pricePerLiter = parseEuroNumber(m[1]);
          out.liters = parseEuroNumber(m[2]);
          const lineAmount = parseEuroNumber(m[3]);
          if (out.total == null) out.total = lineAmount;
        }
      } else {
        out.confidenceNotes.push("No he detectado con claridad litros y ‚Ç¨/L.");
      }

      // Acumulaci√≥n Carrefour (5,92 EUR)
      const accumMatch =
        text.match(/ACUMULACI[√ìO]N(?:\s*%|)\s+(\d+[.,]\d{2})\s*EUR/i) ||
        text.match(/TOTAL\s+AHORRO\s+ESTA\s+COMPRA\s+(\d+[.,]\d{2})/i);

      if (accumMatch) out.carrefourAccum = parseEuroNumber(accumMatch[1]);

      return out;
    }

    function parseEuroNumber(s) {
      return parseFloat(String(s).replace(/\./g, "").replace(",", "."));
    }

    function approxEqual(a, b, tolAbs = 0.20, tolRel = 0.01) {
      if (a == null || b == null) return false;
      const diff = Math.abs(a - b);
      const rel = b !== 0 ? diff / Math.abs(b) : diff;
      return diff <= tolAbs || rel <= tolRel;
    }

    function validateParsedTicket(parsed) {
      const warnings = [];
      const suggestions = [];

      const total = parsed.total;
      const liters = parsed.liters;
      const ppl = parsed.pricePerLiter;

      if (total != null && liters != null && ppl != null && liters > 0 && ppl > 0) {
        const expected = liters * ppl;
        const ok = approxEqual(expected, total, 0.30, 0.015);
        if (!ok) {
          warnings.push(`Coherencia: litros √ó ‚Ç¨/L = ${expected.toFixed(2)} ‚Ç¨, pero el total es ${total.toFixed(2)} ‚Ç¨. Puede haber un fallo OCR.`);
          suggestions.push(`Sugerencia precio/L probable: ${(total / liters).toFixed(3)} ‚Ç¨/L (total √∑ litros)`);
          suggestions.push(`Sugerencia litros probables: ${(total / ppl).toFixed(2)} L (total √∑ ‚Ç¨/L)`);
        }
      }

      if (parsed.station === "carrefour" && parsed.carrefourAccum != null && total != null && total > 0) {
        const acc = parsed.carrefourAccum;
        const ratio = acc / total;
        // En ticket solo carburante ratio ~ 0.08
        if (!approxEqual(ratio, 0.08, 0.01, 0.08)) {
          warnings.push(`Carrefour: la acumulaci√≥n detectada (${acc.toFixed(2)} ‚Ç¨) no parece ser el 8% del total (${total.toFixed(2)} ‚Ç¨). Si el ticket tiene compras de tienda, indica "Base carburante para 8%".`);
          suggestions.push(`Base carburante estimada por acumulaci√≥n: ${(acc / 0.08).toFixed(2)} ‚Ç¨ (acumulaci√≥n √∑ 0.08)`);
        }
      }

      return { warnings, suggestions };
    }

    function renderOcrResult(parsed, rawText) {
      const rows = [];
      rows.push(row("Fecha", parsed.dateISO || "‚Äî"));
      rows.push(row("Estaci√≥n detectada", STATIONS[parsed.station] || "Otro"));
      rows.push(row("Total ticket", parsed.total != null ? parsed.total.toFixed(2) + " ‚Ç¨" : "‚Äî"));
      rows.push(row("Litros", parsed.liters != null ? parsed.liters.toFixed(2) + " L" : "‚Äî"));
      rows.push(row("Precio/L", parsed.pricePerLiter != null ? parsed.pricePerLiter.toFixed(3) + " ‚Ç¨/L" : "‚Äî"));

      if (parsed.station === "carrefour" && parsed.carrefourAccum != null) {
        rows.push(row("Acumulaci√≥n Carrefour detectada", parsed.carrefourAccum.toFixed(2) + " ‚Ç¨"));
      }

      if (parsed.confidenceNotes?.length) {
        rows.push(`<div style="margin-top:10px; color:#b33; font-size:12px;">‚ö†Ô∏è ${parsed.confidenceNotes.map(escapeHtml).join(" ")}</div>`);
      }

      if (parsed._validation?.warnings?.length) {
        rows.push(`
          <div style="margin-top:12px; padding:10px; border-radius:8px; background:#fff3cd; border:1px solid #ffeeba; color:#7a5a00; font-size:12px;">
            <strong>‚ö†Ô∏è Avisos</strong><br>
            ${parsed._validation.warnings.map(w => `‚Ä¢ ${escapeHtml(w)}`).join("<br>")}
          </div>
        `);
      }

      if (parsed._validation?.suggestions?.length) {
        rows.push(`
          <div style="margin-top:10px; padding:10px; border-radius:8px; background:#f0f7ff; border:1px solid #cfe2ff; color:#234; font-size:12px;">
            <strong>üí° Sugerencias</strong><br>
            ${parsed._validation.suggestions.map(s => `‚Ä¢ ${escapeHtml(s)}`).join("<br>")}
          </div>
        `);
      }

      rows.push(`<details style="margin-top:12px;">
        <summary style="cursor:pointer; color:#666; font-size:12px;">Ver texto OCR</summary>
        <pre style="white-space:pre-wrap; font-size:11px; background:#f8f9fa; padding:10px; border-radius:8px; border:1px solid #eee;">${escapeHtml(rawText)}</pre>
      </details>`);

      document.getElementById("ocrResult").innerHTML = rows.join("");
    }

    function row(label, value) {
      return `
        <div class="preview-row">
          <span>${escapeHtml(label)}:</span>
          <span><strong>${escapeHtml(value)}</strong></span>
        </div>
      `;
    }

    function applyOcrResult() {
      if (!lastOcrResult) return;

      document.getElementById("category").value = "fuel";
      toggleFuelFields();

      if (lastOcrResult.dateISO) document.getElementById("date").value = lastOcrResult.dateISO;
      if (lastOcrResult.total != null) document.getElementById("amount").value = lastOcrResult.total.toFixed(2);
      if (lastOcrResult.liters != null) document.getElementById("liters").value = lastOcrResult.liters.toFixed(2);
      if (lastOcrResult.pricePerLiter != null) document.getElementById("pricePerLiter").value = lastOcrResult.pricePerLiter.toFixed(3);

      document.getElementById("station").value = lastOcrResult.station || "other";

      // Carrefour: marcamos club y si hay acumulaci√≥n estimamos base si parece ticket mixto
      if (lastOcrResult.station === "carrefour") {
        document.getElementById("clubCarrefour").checked = true;
        const acc = lastOcrResult.carrefourAccum;
        const total = lastOcrResult.total;

        if (acc != null && total != null) {
          const estimatedBase = acc / 0.08;
          if (estimatedBase > 0 && Math.abs(estimatedBase - total) > 0.5) {
            document.getElementById("carrefourFuelBase").value = estimatedBase.toFixed(2);
          } else {
            document.getElementById("carrefourFuelBase").value = "";
          }
        }
      } else {
        document.getElementById("clubCarrefour").checked = false;
        document.getElementById("carrefourFuelBase").value = "";
      }

      togglePromoFields();
      updatePreview();
      closeOcrModal();
    }

    // =========================
    // INIT
    // =========================
    window.addEventListener("DOMContentLoaded", () => {
      try {
        loadDB();
      } catch (e) {
        // si algo va mal, reseteamos db
        const car = { id: uid(), name: "Mi coche", baselineOdometer: 0 };
        db = { cars: [car], selectedCarId: car.id, selectedYear: "all", expenses: [] };
        saveDB();
      }

      renderCarSelect();
      recomputeYearOptions();

      document.getElementById("date").valueAsDate = new Date();
      toggleFuelFields();
      togglePromoFields();

      updateScopeLabel();
      updateDashboard();
      renderExpensesList();
      renderStats();

      registerServiceWorker();
      initInstallPrompt();
    });
  </script>
</body>
</html>
